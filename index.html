<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="مسابقة معلومات تفاعلية لاختبار ثقافتك في مستويات متعددة.">
    <title>🧠 مسابقة المعلومات | Hybrid Edition</title>

    <link rel="icon" type="image/png" href="https://em-content.zobj.net/thumbs/120/apple/354/brain_1f9e0.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Cropper.js for image editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="style.css">

    <!-- JSON-LD for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoGame",
      "name": "🧠 مسابقة المعلومات",
      "description": "لعبة مسابقة تفاعلية لاختبار المعلومات في مستويات متعددة",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Web Browser",
      "author": {
        "@type": "Person",
        "name": "MS AbuQusay"
      }
    }
    </script>
</head>
<body data-theme="dark" aria-live="polite">
    <div id="toast-container" class="toast-container" aria-live="assertive"></div>
    <div id="reportErrorFab" class="report-fab" role="button" aria-label="الإبلاغ عن مشكلة" data-action="showAdvancedReportModal">⚠️</div>
    <div id="devFloatingBtn" class="dev-fab" role="button" title="تبديل وضع المطور" style="display: none;"><span>⚡</span></div>

    <!-- Global Error Overlay -->
    <div id="globalErrorOverlay" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>حدث خطأ</h2></header>
            <p id="globalErrorMessage">لا يمكن تحميل موارد اللعبة. الرجاء التحقق من اتصالك بالإنترنت.</p>
            <div class="button-group">
                <button id="retryConnectionBtn" class="btn-main">إعادة المحاولة</button>
            </div>
        </div>
    </div>
    
    <!-- SCREENS -->
    <div id="loader" class="screen active" role="status" aria-label="جاري التحميل">
        <div class="spinner" aria-hidden="true"></div>
        <p id="loaderText" class="game-subtitle" style="margin-top: 1rem;">جاري تحميل اللعبة...</p>
    </div>

    <div id="startScreen" class="screen">
        <div class="content-box">
            <header class="screen-header">
                <h1 class="game-title">🧠 مسابقة المعلومات</h1>
                <p class="game-subtitle">اختبر قدراتك في مسابقة تفاعلية شيقة</p>
            </header>
            <div class="button-group">
                <button data-action="showAvatarScreen" class="btn-main">ابدأ اللعب</button>
                <button data-action="showLeaderboard" class="btn-secondary">لوحة الصدارة</button>
                <button data-action="showDevPasswordModal" class="btn-secondary">وضع المطور</button>
            </div>
        </div>
    </div>
    
    <div id="avatarScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>اختر صورتك الرمزية</h2></header>
            <div class="avatar-grid" role="group" aria-label="خيارات الصور الرمزية"></div>
            <div class="button-group">
                <button id="confirmAvatarBtn" class="btn-main" disabled data-action="showNameEntryScreen">التالي</button>
            </div>
        </div>
    </div>

    <div id="nameEntryScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>أدخل اسمك</h2></header>
            <div class="form-group">
                <label for="nameInput" class="sr-only">اسم اللاعب</label>
                <input type="text" id="nameInput" placeholder="مثلا: عبد الله" maxlength="25" autocomplete="name" aria-required="true" aria-describedby="nameError">
                <div id="nameError" class="error-message" aria-live="polite"></div>
            </div>
            <div class="button-group">
                <button id="confirmNameBtn" class="btn-main" disabled data-action="confirmName">تأكيد الإسم</button>
            </div>
        </div>
    </div>
    
    <div id="instructionsScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>📋 تعليمات اللعبة</h2></header>
            <div class="instructions-content">
                <div class="instruction-item"><span class="instruction-icon">⚖️</span><div><strong>النقاط:</strong><br>صحيحة: +100 / خاطئة: -100</div></div>
                <div class="instruction-item"><span class="instruction-icon">⏱️</span><div><strong>الوقت:</strong><br>لكل سؤال وقت محدد</div></div>
                <div class="instruction-item"><span class="instruction-icon">🛠️</span><div><strong>المساعدات:</strong><br>50:50/تجميد: -100 | التخطي: -20 (وتتزايد)</div></div>
                <div class="instruction-item"><span class="instruction-icon">🎯</span><div><strong>المستويات:</strong><br>سهل / متوسط / صعب / مستحيل</div></div>
                <div class="instruction-item"><span class="instruction-icon">🚫</span><div><strong>الأخطاء:</strong><br>مسموح 3 فقط</div></div>
                <div class="instruction-item"><span class="instruction-icon">📩</span><div><strong>الدعم:</strong><br>تواصل عبر <a href="https://x.com/_MS_AbuQusay" target="_blank" rel="noopener noreferrer">X</a> أو <a href="https://www.instagram.com/_ms_abuqusay" target="_blank" rel="noopener noreferrer">Instagram</a>.</div></div>
            </div>
            <div class="button-group">
                <button class="btn-main" data-action="postInstructionsStart">حسناً، فهمت</button>
            </div>
        </div>
    </div>

    <div id="levelSelectScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>اختر مستوى للبدء (وضع المطور)</h2></header>
            <div class="level-selection-grid">
                <button class="btn-secondary" data-level-index="0" data-action="startDevLevel">سهل</button>
                <button class="btn-secondary" data-level-index="1" data-action="startDevLevel">متوسط</button>
                <button class="btn-secondary" data-level-index="2" data-action="startDevLevel">صعب</button>
                <button class="btn-secondary" data-level-index="3" data-action="startDevLevel">مستحيل</button>
            </div>
        </div>
    </div>

    <main id="gameContainer" class="screen">
        <div class="top-bar">
            <button class="end-quiz-btn" aria-label="إنهاء المسابقة" data-action="showConfirmExitModal">🚪 إنهاء</button>
            <div class="level-progress">
                <div class="level-indicator" data-level="easy" data-tooltip="المستوى السهل">1</div>
                <div class="level-indicator" data-level="medium" data-tooltip="المستوى المتوسط">2</div>
                <div class="level-indicator" data-level="hard" data-tooltip="المستوى الصعب">3</div>
                <div class="level-indicator" data-level="impossible" data-tooltip="المستوى المستحيل">4</div>
            </div>
            <button class="theme-toggle-btn" aria-label="تبديل وضع السطوع والظلام" data-action="toggleTheme">☀️</button>
        </div>
        
        <header class="game-header">
            <div class="player-info">
                <div class="player-main">
                    <img id="playerAvatar" src="" alt="الصورة الرمزية للاعب" loading="lazy" decoding="async">
                    <div class="player-details">
                        <span id="playerName" aria-label="اسم اللاعب"></span>
                        <span id="playerId" class="player-id"></span>
                    </div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">النقاط: <strong id="currentScore" aria-live="polite">100</strong></div>
                    <div class="stat-item">الأخطاء: <strong id="wrongAnswersCount" aria-live="assertive">0 / 3</strong></div>
                    <div class="stat-item">التخطي: <strong id="skipCount">0</strong></div>
                </div>
            </div>
            <div class="helpers" aria-label="خيارات المساعدة">
                <button class="helper-btn" data-type="fiftyFifty" aria-describedby="fiftyFiftyDesc"><span class="sr-only">مساعدة 50:50</span>50:50<span class="helper-cost">(100)</span></button>
                <button class="helper-btn" data-type="freezeTime" aria-describedby="freezeTimeDesc"><span class="sr-only">مساعدة تجميد الوقت</span>❄️ 10ث<span class="helper-cost">(100)</span></button>
                <button class="helper-btn" data-type="skipQuestion" aria-describedby="skipQuestionDesc"><span class="sr-only">تخطي السؤال</span>⏭️ تخطي<span id="skipCost" class="helper-cost">(20)</span></button>
            </div>
        </header>

        <div class="timer-container" aria-label="مؤقت السؤال">
            <div class="timer-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100"></div>
            <span id="timer" class="timer-text">30</span>
        </div>

        <div class="main-content">
            <section class="question-box" aria-labelledby="questionCounter">
                <div class="level-badge" id="currentLevelBadge">سهل</div>
                <h3 id="questionCounter">السؤال 1 من 5</h3>
                <p id="questionText" aria-live="polite"></p>
            </section>
            <section class="options-container" aria-labelledby="questionText">
                <div class="options-grid" role="group" aria-label="خيارات الإجابة"></div>
            </section>
        </div>
    </main>

    <div id="levelCompleteScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2 id="levelCompleteTitle">🎉 أكملت المستوى!</h2></header>
            <div class="level-stats">
                <p>النقاط الحالية: <strong id="levelScore"></strong></p>
                <p>عدد الأخطاء: <strong id="levelErrors"></strong></p>
                <p>الأسئلة الصحيحة: <strong id="levelCorrect"></strong></p>
            </div>
            <div class="button-group">
                <button class="btn-main" data-action="nextLevel">المستوى التالي</button>
                <button class="btn-secondary" data-action="endGame">الانسحاب وعرض النتائج</button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>🏆 النتائج النهائية 🏆</h2></header>
            <div class="final-stats">
                <p>✍️ الاسم: <strong id="finalName"></strong></p>
                <p>🆔 المعرّف: <strong id="finalId"></strong></p>
                <p>🔢 رقم المحاولة: <strong id="finalAttemptNumber"></strong></p>
                <p>✅ الإجابات الصحيحة: <strong id="finalCorrect"></strong></p>
                <p>❌ الإجابات الخاطئة: <strong id="finalWrong"></strong></p>
                <p>⏭️ مرات التخطي: <strong id="finalSkips"></strong></p>
                <p>⭐ النقاط النهائية: <strong id="finalScore"></strong></p>
                <p>⏱️ الوقت المستغرق: <strong id="totalTime"></strong></p>
                <p>📈 المستوى الذي وصلت إليه: <strong id="finalLevel"></strong></p>
                <p>🎯 نسبة الدقة: <strong id="finalAccuracy"></strong></p>
                <p>⏳ متوسط وقت الإجابة: <strong id="finalAvgTime"></strong></p>
                <div class="performance-rating"><span>أداؤك: </span><strong id="performanceText"></strong></div>
            </div>
            <section class="share-section">
                <h3>📢 مشاركة النتائج</h3>
                <div class="share-buttons">
                    <button class="share-btn x" data-action="shareOnX">X</button>
                    <button class="share-btn instagram" data-action="shareOnInstagram">Instagram</button>
                </div>
            </section>
            <div class="button-group">
                <button class="btn-main" data-action="playAgain">لعب مرة أخرى</button>
                <button class="btn-secondary" data-action="showLeaderboard">لوحة الصدارة</button>
            </div>
        </div>
    </div>
    
    <div id="leaderboardScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>🏆 لوحة الصدارة 🏆</h2></header>
            <div id="leaderboardContent" aria-live="polite"></div>
            <div class="button-group">
                <button class="btn-secondary" data-action="showStartScreen">العودة</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="confirmExitModal" class="modal">
        <div class="modal-content">
            <h3>إنهاء المسابقة</h3>
            <p>سيتم حفظ نقاطك الحالية. هل ترغب في المتابعة؟</p>
            <div class="modal-buttons">
                <button class="btn-main" data-action="endGame">نعم</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="confirmExitModal">لا</button>
            </div>
        </div>
    </div>
    
    <div id="advancedReportModal" class="modal">
        <div class="modal-content">
            <h3>الإبلاغ عن مشكلة</h3>
            <form id="reportProblemForm">
                <div class="form-group">
                    <label for="problemType">نوع المشكلة:</label>
                    <select id="problemType" name="problemType" required>
                        <option value="">اختر نوع المشكلة...</option>
                        <option value="technical">مشكلة تقنية (تجمد، بطء)</option>
                        <option value="question_error">خطأ في السؤال أو الإجابة</option>
                        <option value="account_issue">مشكلة في الحساب أو النقاط</option>
                        <option value="suggestion">اقتراح لتحسين اللعبة</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>اقتراحات سريعة:</label>
                    <div class="suggestion-tags">
                        <button type="button" class="suggestion-tag" data-suggestion="السؤال لا يظهر بشكل صحيح.">سؤال لا يظهر</button>
                        <button type="button" class="suggestion-tag" data-suggestion="الإجابة الصحيحة تبدو خاطئة.">إجابة غير صحيحة</button>
                        <button type="button" class="suggestion-tag" data-suggestion="توقفت اللعبة فجأة.">تجمد اللعبة</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="problemDescription">وصف المشكلة:</label>
                    <textarea id="problemDescription" name="problemDescription" placeholder="يرجى تقديم تفاصيل دقيقة..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="reportScreenshotInput" class="upload-btn-label">
                        📷 إرفاق لقطة شاشة (اختياري)
                    </label>
                    <input type="file" id="reportScreenshotInput" accept="image/*" class="sr-only">
                    <img id="screenshotPreview" src="" alt="معاينة لقطة الشاشة" class="screenshot-preview">
                </div>
                <div id="reportSpinner" class="spinner" style="display: none; margin: 1rem auto;"></div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-main" id="submitReportBtn">إرسال البلاغ</button>
                    <button type="button" class="btn-secondary" data-action="closeModal" data-modal-id="advancedReportModal">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="avatarEditorModal" class="modal">
        <div class="modal-content">
            <h3>تعديل الصورة الرمزية</h3>
            <div id="image-editor-container"><img id="image-to-crop" src="" alt="Image for cropping"></div>
            <div class="modal-buttons">
                <button class="btn-main" data-action="saveCroppedAvatar">حفظ الصورة</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="avatarEditorModal">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="devPasswordModal" class="modal">
        <div class="modal-content">
            <h3>وضع المطور</h3>
            <p>الرجاء إدخال كلمة المرور.</p>
            <div class="form-group" style="margin: 1rem 0 0.5rem;">
                <label for="devPasswordInput" class="sr-only">كلمة المرور</label>
                <input type="password" id="devPasswordInput" placeholder="كلمة المرور" aria-describedby="devPasswordError">
            </div>
            <div id="devPasswordError" class="error-message"></div>
            <div class="modal-buttons">
                <button class="btn-main" data-action="checkDevPassword">دخول</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="devPasswordModal">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="playerDetailsModal" class="modal">
        <div class="modal-content player-details-redesigned">
             <header class="player-details-header">
                <img id="detailsAvatar" src="" alt="صورة اللاعب الرمزية" class="player-details-avatar">
                <div>
                    <h3 id="detailsName"></h3>
                    <span id="detailsPlayerId" class="player-id"></span>
                </div>
            </header>
            <div id="playerDetailsContent" class="player-details-body">
                <!-- Content will be injected by JS -->
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" data-action="closeModal" data-modal-id="playerDetailsModal">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Link to external JS file -->
    <script src="script.js" defer></script>
</body>
</html>
