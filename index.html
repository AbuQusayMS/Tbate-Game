<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Supabase SDK (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/*** === Design System === ***/
:root{
  --bg:#1a1a2e; --surface:#16213e; --surface-2:#0f3460; --text:#f0f0f0; --accent:#e7b416;
  --muted:#c9d1d9; --danger:#ef4444; --ok:#10b981; --primary:#2563eb;
  --radius:16px; --shadow:0 10px 20px rgba(0,0,0,.15);
  --gap:14px; --btn-h:46px;
}
.theme-light{
  --bg:#f8fafc; --surface:#ffffff; --surface-2:#e2e8f0; --text:#1e293b; --accent:#e7b416;
  --muted:#475569; --danger:#ef4444; --ok:#10b981; --primary:#2563eb;
}
*{box-sizing:border-box}
html,body{margin:0}
body{font-family:"Cairo",system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
main{max-width:980px;margin:0 auto;padding:16px}

/*** Header / Footer ***/
.app-header,.app-footer{position:sticky;background:transparent;backdrop-filter:saturate(1.2) blur(6px);z-index:20}
.app-header{top:0;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
.app-footer{bottom:0;padding:10px 14px}
.brand{font-weight:700}
.header-actions{display:flex;gap:8px;align-items:center}

/*** Buttons ***/
.icon-btn,.ghost-btn,.primary,.secondary,.helper,.pill{
  height:var(--btn-h);border-radius:999px;border:1px solid transparent;padding:0 16px;cursor:pointer;font-weight:700
}
.icon-btn{width:var(--btn-h);display:grid;place-items:center;background:var(--surface-2);color:var(--text);border:1px solid rgba(255,255,255,.08)}
.ghost-btn{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
.primary{background:var(--accent);color:#1b1b1b}
.secondary{background:var(--surface-2);color:var(--text);border:1px solid rgba(255,255,255,.12)}
.helper{background:var(--surface-2);color:var(--text);border:1px solid rgba(255,255,255,.12);min-width:120px}
.helper small{opacity:.85}
.pill{background:var(--surface-2);color:var(--text);border:1px solid rgba(255,255,255,.12);height:36px;padding:0 12px}
.pill.active{outline:2px solid var(--accent)}

.text-input,.text-area,select{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
  background:var(--surface-2);color:var(--text);outline:none
}
.text-input:focus,.text-area:focus,select:focus{border-color:var(--accent)}
textarea.share-text{height:160px}

/*** Layout ***/
.screen{display:none;animation:fade .25s ease}
.screen.active{display:block}
@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.card.center{text-align:center}
.hint,.muted{color:var(--muted);font-size:.95rem}
.mt-3{margin-top:12px}.mt-4{margin-top:18px}
.row{display:flex;gap:10px;align-items:center}
.stack{display:flex;flex-direction:column}
.gap-3{gap:12px}
.pill-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}

/*** Avatars ***/
.avatar-grid{display:grid;grid-template-columns:repeat(5,minmax(56px,1fr));gap:10px}
.avatar{display:grid;place-items:center;height:56px;border-radius:14px;background:var(--surface-2);font-size:28px;cursor:pointer;border:2px solid transparent}
.avatar.selected{border-color:var(--accent)}
.avatar-chip{display:flex;gap:6px;align-items:center}

/*** Game HUD ***/
.hud{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.hud-right{display:flex;gap:8px;align-items:center}
.chip{background:var(--surface-2);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);font-size:.95rem}

/*** Helpers / Timer ***/
.helpers{display:flex;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.timer{position:relative;height:14px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;margin:12px 0}
.timer-bar{position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,#10b981,#f59e0b,#ef4444)}
.timer-label{position:absolute;inset:0;display:grid;place-items:center;font-weight:700}

/*** Question ***/
.level-badge{display:inline-block;background:var(--surface-2);padding:4px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);font-size:.9rem;margin-bottom:6px}
.options{display:grid;gap:10px;margin-top:12px}
.option{padding:14px;border-radius:12px;background:var(--surface-2);border:1px solid rgba(255,255,255,.12);cursor:pointer;text-align:right}
.option.disabled{opacity:.5;pointer-events:none}
.option.correct{outline:2px solid var(--ok)}
.option.wrong{outline:2px solid var(--danger)}

/*** Lists ***/
.list{display:flex;flex-direction:column;gap:8px}
.row-item{display:flex;align-items:center;gap:10px;background:var(--surface-2);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);cursor:pointer}
.row-item .rank{width:28px;text-align:center;font-weight:700}
.row-item .avatar{height:40px;width:40px;font-size:22px}

/*** Results ***/
.result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.kv{background:var(--surface-2);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
.kv b{display:block;margin-bottom:6px}
.share-box{margin-top:16px}

/*** Modals ***/
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;padding:14px}
.modal.hidden{display:none}
.modal-content{max-width:700px;width:100%;background:var(--surface);border-radius:16px;padding:16px;position:relative}
.modal-close{position:absolute;left:10px;top:8px;background:transparent;border:0;font-size:22px;color:var(--text);cursor:pointer}

/*** FAB ***/
.fab{height:56px;width:56px;border-radius:999px;border:0;background:var(--accent);color:#111;box-shadow:var(--shadow);cursor:pointer;position:fixed;bottom:16px;right:16px}

/*** Small screens ***/
@media (max-width:480px){
  main{padding:12px}
  .avatar-grid{grid-template-columns:repeat(4,minmax(56px,1fr))}
}
</style>
</head>
<body class="theme-dark">
<header class="app-header">
  <div class="brand">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ğŸ§ </div>
  <div class="header-actions">
    <button id="themeToggle" class="icon-btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ“</button>
    <button id="gotoLeaderboard" class="ghost-btn">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ğŸ†</button>
  </div>
</header>

<main id="app">

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
  <section id="screen-start" class="screen active">
    <div class="card center">
      <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h1>
      <p class="muted">Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ù…ØªØ¹Ø© ÙˆØ³Ø±ÙŠØ¹Ø©</p>
      <div class="stack gap-3">
        <button id="startBtn" class="primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
        <button id="openDevBtn" class="ghost-btn">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± âš™ï¸</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© -->
  <section id="screen-avatar" class="screen">
    <div class="card">
      <h2>Ø§Ø®ØªØ± ØµÙˆØ±ØªÙƒ Ø§Ù„Ø±Ù…Ø²ÙŠØ©</h2>
      <div id="avatarGrid" class="avatar-grid"></div>
      <div class="stack mt-4">
        <button id="avatarNextBtn" class="primary" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button data-back="#screen-start" class="secondary back-btn">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… -->
  <section id="screen-name" class="screen">
    <div class="card">
      <h2>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</h2>
      <input id="playerNameInput" class="text-input" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡" maxlength="25"/>
      <div class="hint">Ø¨ÙŠÙ† 2 Ùˆ 25 Ø­Ø±ÙÙ‹Ø§</div>
      <div class="stack mt-4">
        <button id="confirmNameBtn" class="primary" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³Ù…</button>
        <button data-back="#screen-avatar" class="secondary back-btn">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
  <section id="screen-instructions" class="screen">
    <div class="card">
      <h2>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ“‹</h2>
      <ul class="bullets">
        <li>âœ… ØµØ­ÙŠØ­Ø© +100 | âŒ Ø®Ø§Ø·Ø¦Ø© -50 | ğŸ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³Ø±Ø¹Ø© +50</li>
        <li>â± Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ 30 Ø«Ø§Ù†ÙŠØ©</li>
        <li>ğŸ›  Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª:
          50:50 (Ù…Ø±Ø©/Ø¬ÙˆÙ„Ø©) | â„ï¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ 10Ø« (Ù…Ø±Ø©/Ø¬ÙˆÙ„Ø©) | â­ Ø§Ù„ØªØ®Ø·ÙŠ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ (ÙŠØ¨Ø¯Ø£ 20 ÙˆÙŠØ²ÙŠØ¯ +20 ÙƒÙ„ Ù…Ø±Ø©)
        </li>
        <li>ğŸš« Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§: 3</li>
        <li>ğŸ¯ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (31 Ø³Ø¤Ø§Ù„): 10 Ø³Ù‡Ù„ØŒ 10 Ù…ØªÙˆØ³Ø·ØŒ 10 ØµØ¹Ø¨ØŒ 1 Ù…Ø³ØªØ­ÙŠÙ„</li>
        <li>Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰: <b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</b> Ø£Ùˆ <b>Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</b></li>
      </ul>
      <div class="stack mt-4">
        <button id="startRoundBtn" class="primary">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button data-back="#screen-name" class="secondary back-btn">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ÙÙ‚Ø·) -->
  <section id="screen-level-select" class="screen">
    <div class="card">
      <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ÙÙ‚Ø·)</h2>
      <div class="pill-row">
        <button class="pill" data-level="easy">Ø³Ù‡Ù„</button>
        <button class="pill" data-level="medium">Ù…ØªÙˆØ³Ø·</button>
        <button class="pill" data-level="hard">ØµØ¹Ø¨</button>
        <button class="pill" data-level="impossible">Ù…Ø³ØªØ­ÙŠÙ„</button>
      </div>
      <div class="stack mt-4">
        <button data-back="#screen-instructions" class="secondary back-btn">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </section>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
  <section id="screen-game" class="screen">
    <div class="hud">
      <div class="level-dots" id="levelDots"></div>
      <div class="hud-right">
        <div class="chip" id="hudScore">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
        <div class="chip" id="hudMistakes">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: 0/3</div>
        <div class="chip avatar-chip"><span id="hudAvatar">ğŸ™‚</span><span id="hudName">â€”</span></div>
      </div>
    </div>

    <div class="helpers">
      <button id="btnSkip" class="helper">â­ ØªØ®Ø·ÙŠ <small id="skipCost">(20)</small></button>
      <button id="btnFreeze" class="helper">â„ï¸ ØªØ¬Ù…ÙŠØ¯ <small>10Ø«</small></button>
      <button id="btnFifty" class="helper">ğŸ”€ 50:50</button>
    </div>

    <div class="timer">
      <div id="timerBar" class="timer-bar"></div>
      <div id="timerLabel" class="timer-label">30</div>
    </div>

    <div class="card question-card">
      <div class="level-badge" id="levelBadge">Ø³Ù‡Ù„</div>
      <div id="qCounter" class="muted">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</div>
      <h3 id="questionText">...</h3>
      <div id="options" class="options"></div>
    </div>
  </section>

  <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ -->
  <section id="screen-level-end" class="screen">
    <div class="card center">
      <h2>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ğŸ¯</h2>
      <div class="stack mt-4">
        <button id="btnNextLevel" class="primary">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="btnWithdraw" class="ghost-btn">Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
  <section id="screen-results" class="screen">
    <div class="card">
      <h2>ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ†</h2>
      <div class="result-grid" id="finalResults"></div>

      <div class="share-box">
        <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ“¢</h3>
        <div class="stack">
          <button id="shareXBtn" class="primary">Ø§Ù†Ø´Ø± Ø¹Ù„Ù‰ ğ•</button>
          <button id="copyShareTextBtn" class="secondary">Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
        </div>
        <textarea id="shareText" class="share-text" readonly></textarea>
      </div>

      <div class="stack mt-4">
        <button id="playAgainBtn" class="primary">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button id="openLeaderboardBtn" class="ghost-btn">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
      </div>
    </div>
  </section>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© -->
  <section id="screen-leaderboard" class="screen">
    <div class="card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ğŸ†</h2>
      <div class="pill-row" id="lbFilters">
        <button class="pill active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
        <button class="pill" data-filter="top10">Ø£ÙØ¶Ù„ 10</button>
        <button class="pill" data-filter="impossible">Ù…ØªØ®Ø·Ù‘Ùˆ Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„</button>
      </div>
      <div id="leaderboardList" class="list"></div>
      <div class="stack mt-4">
        <button data-back="#screen-start" class="secondary back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
      </div>
    </div>
  </section>

  <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
  <div id="playerDetailsModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" id="closePlayerModal">Ã—</button>
      <h3>ØªÙØ§ØµÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
      <div id="playerDetailsBody" class="list thin"></div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª -->
  <div id="reportModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" id="closeReport">Ã—</button>
      <h3>Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø© ğŸ› ï¸</h3>
      <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
      <select id="reportType" class="text-input">
        <option>Ø³Ø¤Ø§Ù„ ØºÙŠØ± ÙˆØ§Ø¶Ø­</option>
        <option>Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</option>
        <option>Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ</option>
        <option>Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ø¤Ù‚Øª</option>
        <option>Ù…Ø´ÙƒÙ„Ø© Ø¹Ø±Ø¶/Ù„ØºØ©</option>
      </select>
      <label class="label">Ø§Ù„ÙˆØµÙ</label>
      <textarea id="reportDesc" class="text-area" rows="3" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø¥ÙŠØ¬Ø§Ø²"></textarea>
      <label class="label">ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="reportImage" type="file" accept="image/*"/>
      <div class="row"><label><input type="checkbox" id="reportAuto" checked/> Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ</label></div>
      <div class="stack mt-3"><button id="sendReportBtn" class="primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button></div>
    </div>
  </div>

</main>

<footer class="app-footer">
  <button id="openReportBtn" class="fab" title="Ø¥Ø¨Ù„Ø§Øº">âš ï¸</button>
</footer>

<script>
/* ====== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====== */
const CONFIG = {
  TEST_KEY: 'AbuQusay',
  APPS_SCRIPT_URL: 'PUT_YOUR_GAS_ENDPOINT_HERE', // Ø¶Ø¹ Ø±Ø§Ø¨Ø· GAS (Web App) Ù‡Ù†Ø§
  SUPABASE_URL: 'PUT_SUPABASE_URL_HERE',
  SUPABASE_KEY: 'PUT_SUPABASE_ANON_KEY_HERE',
  QUESTION_TIME: 30,
  MAX_WRONG: 3,
  STARTING_SCORE: 100,
  DEV_PASSWORD: 'developer'
};
const LEVEL_LABEL = { easy:'Ø³Ù‡Ù„', medium:'Ù…ØªÙˆØ³Ø·', hard:'ØµØ¹Ø¨', impossible:'Ù…Ø³ØªØ­ÙŠÙ„' };
const LEVEL_ORDER = ['easy','medium','hard','impossible'];
const LEVEL_COUNTS = { easy:10, medium:10, hard:10, impossible:1 };

/* ====== Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (31 Ø³Ø¤Ø§Ù„Ù‹Ø§) ====== */
const BUILTIN_QUESTIONS = {
  "easy": [
    { "q": "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±ØŸ", "options": ["Ø£Ø²Ø±Ù‚", "Ø£Ø­Ù…Ø±", "Ø£Ø³ÙˆØ¯", "Ø£Ø®Ø¶Ø±"], "correct": 0 },
    { "q": "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£ØµØ§Ø¨Ø¹ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙˆØ§Ø­Ø¯Ø©ØŸ", "options": ["5", "4", "6", "7"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠÙÙ„Ù‚Ø¨ Ø¨Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©ØŸ", "options": ["Ø§Ù„Ø£Ø³Ø¯", "Ø§Ù„ÙÙŠÙ„", "Ø§Ù„Ù†Ù…Ø±", "Ø§Ù„Ø°Ø¦Ø¨"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ù†Ø´Ø±Ø¨Ù‡ ÙƒÙ„ ÙŠÙˆÙ…ØŸ", "options": ["Ù…Ø§Ø¡", "Ø²ÙŠØª", "Ø­Ø¨Ø±", "Ø±Ù…Ù„"], "correct": 0 },
    { "q": "ÙƒÙ… Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©ØŸ", "options": ["60", "30", "45", "90"], "correct": 0 },
    { "q": "Ù…Ø§ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", "options": ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø¯Ù…Ø´Ù‚", "Ø·Ø±Ø§Ø¨Ù„Ø³"], "correct": 0 },
    { "q": "Ù…Ø§ Ù‡Ùˆ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆØ² Ø§Ù„Ù†Ø§Ø¶Ø¬ØŸ", "options": ["Ø£ØµÙØ±", "Ø£Ø®Ø¶Ø±", "Ø£Ø³ÙˆØ¯", "Ø£Ø²Ø±Ù‚"], "correct": 0 },
    { "q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ„ 'Ù…ÙˆÙˆ'ØŸ", "options": ["Ø¨Ù‚Ø±Ø©", "ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø­ØµØ§Ù†"], "correct": 0 },
    { "q": "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„Ø­Ù„ÙŠØ¨ØŸ", "options": ["Ø£Ø¨ÙŠØ¶", "Ø£ØµÙØ±", "Ø£Ø­Ù…Ø±", "Ø£Ø²Ø±Ù‚"], "correct": 0 },
    { "q": "ÙƒÙ… ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ", "options": ["7", "5", "6", "8"], "correct": 0 }
  ],
  "medium": [
    { "q": "ÙƒÙ… Ø±Ø¬Ù„ Ù„Ù„Ø¹Ù†ÙƒØ¨ÙˆØªØŸ", "options": ["8", "6", "10", "12"], "correct": 0 },
    { "q": "ÙƒÙ… Ø«Ø§Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©ØŸ", "options": ["60", "30", "120", "90"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ ÙŠØ£ØªÙŠ Ø¨Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù†ØŸ", "options": ["Ø´ÙˆØ§Ù„", "Ø±Ø¬Ø¨", "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©", "Ù…Ø­Ø±Ù…"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø­Ù„ÙŠØ¨ØŸ", "options": ["Ø¨Ù‚Ø±Ø©", "Ø¯Ø¬Ø§Ø¬Ø©", "Ø³Ù…ÙƒØ©", "Ù†Ù…Ù„Ø©"], "correct": 0 },
    { "q": "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„ØªÙØ§Ø­Ø© ØºØ§Ù„Ø¨Ù‹Ø§ØŸ", "options": ["Ø£Ø­Ù…Ø±", "Ø£Ø³ÙˆØ¯", "Ø£ØµÙØ±", "Ø¨Ù†ÙØ³Ø¬ÙŠ"], "correct": 0 },
    { "q": "ÙƒÙ… Ø£Ø°Ù†Ø§Ù‹ Ù„Ù„Ø¥Ù†Ø³Ø§Ù†ØŸ", "options": ["Ø§Ø«Ù†ØªØ§Ù†", "ÙˆØ§Ø­Ø¯Ø©", "Ø«Ù„Ø§Ø«", "Ø£Ø±Ø¨Ø¹"], "correct": 0 },
    { "q": "Ù…Ù† Ù‡Ùˆ Ø£Ø¨Ùˆ Ø§Ù„Ø¨Ø´Ø±ØŸ", "options": ["Ø¢Ø¯Ù…", "Ù†ÙˆØ­", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ù…ÙˆØ³Ù‰"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø°ÙŠ Ù†Ø¹ÙŠØ´ Ø¹Ù„ÙŠÙ‡ØŸ", "options": ["Ø§Ù„Ø£Ø±Ø¶", "Ø¹Ø·Ø§Ø±Ø¯", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø§Ù„Ù‚Ù…Ø±"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ø³Ù… ØµÙˆØª Ø§Ù„Ù‚Ø·Ø©ØŸ", "options": ["Ù…ÙˆØ§Ø¡", "Ù†Ø¨Ø§Ø­", "ØµÙ‡ÙŠÙ„", "Ù†Ù‡ÙŠÙ‚"], "correct": 0 },
    { "q": "Ù…Ù† Ø£ÙŠÙ† ØªØ´Ø±Ù‚ Ø§Ù„Ø´Ù…Ø³ØŸ", "options": ["Ù…Ù† Ø§Ù„Ø´Ø±Ù‚", "Ù…Ù† Ø§Ù„ØºØ±Ø¨", "Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„", "Ù…Ù† Ø§Ù„Ø¬Ù†ÙˆØ¨"], "correct": 0 }
  ],
  "hard": [
    { "q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„Ø´Ù…Ø³ØŸ", "options": ["Ø¹Ø·Ø§Ø±Ø¯", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø§Ù„Ø£Ø±Ø¶", "Ø²Ø­Ù„"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø·Ø§Ø¦Ø± Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ·ÙŠØ±ØŸ", "options": ["Ø¨Ø·Ø±ÙŠÙ‚", "Ø­Ù…Ø§Ù…Ø©", "Ø¹ØµÙÙˆØ±", "ØºØ±Ø§Ø¨"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¹ ÙÙŠ ÙÙ„Ø³Ø·ÙŠÙ†ØŸ", "options": ["Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ÙŠØª", "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±", "Ø¨Ø­Ø± Ù‚Ø²ÙˆÙŠÙ†", "Ø¨Ø­Ø± Ø§Ù„Ø¹Ø±Ø¨"], "correct": 0 },
    { "q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ù†Ø±Ø§Ù‡ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ØŸ", "options": ["Ù‚Ù…Ø±", "Ø´Ù…Ø³", "Ø¨Ø­Ø±", "Ø¬Ø¨Ù„"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØ¹ÙŠØ´ ÙÙŠ Ø§Ù„Ø¨Ø­Ø± ÙˆÙ„Ù‡ 8 Ø£Ø°Ø±Ø¹ØŸ", "options": ["Ø£Ø®Ø·Ø¨ÙˆØ·", "Ø­ÙˆØª", "ØªÙ…Ø³Ø§Ø­", "Ø³Ù„Ø­ÙØ§Ø©"], "correct": 0 },
    { "q": "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„Ø¹Ø´Ø¨ØŸ", "options": ["Ø£Ø®Ø¶Ø±", "Ø£ØµÙØ±", "Ø£Ø²Ø±Ù‚", "Ø£Ø³ÙˆØ¯"], "correct": 0 },
    { "q": "ÙƒÙ… Ø¹Ø¯Ø¯ Ù‚Ù„ÙˆØ¨ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ØŸ", "options": ["1", "2", "3", "4"], "correct": 0 },
    { "q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠÙØ³Ù…Ù‰ ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ØŸ", "options": ["ÙƒÙ„Ø¨", "Ù‚Ø·", "Ø­ØµØ§Ù†", "Ø¨Ø·Ø©"], "correct": 0 },
    { "q": "Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØºØ§Ø² Ø§Ù„Ø°ÙŠ Ù†ØªÙ†ÙØ³Ù‡ØŸ", "options": ["Ø£ÙƒØ³Ø¬ÙŠÙ†", "Ø«Ø§Ù†ÙŠ Ø£ÙƒØ³ÙŠØ¯ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†", "Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†", "Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†"], "correct": 0 },
    { "q": "Ù…Ø§ Ø§Ø³Ù… Ø£ÙˆÙ„ Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", "options": ["Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø§Ù„Ù†Ø§Ø³", "Ø§Ù„ÙƒÙˆØ«Ø±"], "correct": 0 }
  ],
  "impossible": [
    { "q": "ÙƒÙ… Ø¥ØµØ¨Ø¹ ÙÙŠ Ø§Ù„ÙŠØ¯ÙŠÙ† Ù…Ø¹Ø§Ù‹ØŸ", "options": ["10", "8", "9", "20"], "correct": 0 }
  ]
};

/* ====== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====== */
const state = {
  player: { name:'', avatar:'ğŸ™‚', playerId:'', deviceId:'' },
  game: {
    currentLevelIndex: 0,
    score: CONFIG.STARTING_SCORE,
    correct: 0, wrong: 0,
    skips: 0, skipCost: 20,
    usedFifty: false, usedFreeze: false,
    questionIndex: 0,
    totalTimeSec: 0,
    timer: null, remaining: CONFIG.QUESTION_TIME, frozen: false
  },
  ui: { devMode:false },
  questions: BUILTIN_QUESTIONS
};

/* ====== DOM ====== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const screens = {
  start: $('#screen-start'), avatar: $('#screen-avatar'), name: $('#screen-name'),
  instructions: $('#screen-instructions'), levelSelect: $('#screen-level-select'),
  game: $('#screen-game'), levelEnd: $('#screen-level-end'),
  results: $('#screen-results'), leaderboard: $('#screen-leaderboard')
};
const els = {
  themeToggle: $('#themeToggle'), gotoLeaderboard: $('#gotoLeaderboard'),
  startBtn: $('#startBtn'), openDevBtn: $('#openDevBtn'),
  avatarGrid: $('#avatarGrid'), avatarNextBtn: $('#avatarNextBtn'),
  playerNameInput: $('#playerNameInput'), confirmNameBtn: $('#confirmNameBtn'),
  startRoundBtn: $('#startRoundBtn'),
  levelDots: $('#levelDots'), hudScore: $('#hudScore'), hudMistakes: $('#hudMistakes'),
  hudAvatar: $('#hudAvatar'), hudName: $('#hudName'),
  btnSkip: $('#btnSkip'), btnFreeze: $('#btnFreeze'), btnFifty: $('#btnFifty'),
  skipCost: $('#skipCost'), timerBar: $('#timerBar'), timerLabel: $('#timerLabel'),
  levelBadge: $('#levelBadge'), qCounter: $('#qCounter'), questionText: $('#questionText'), options: $('#options'),
  btnNextLevel: $('#btnNextLevel'), btnWithdraw: $('#btnWithdraw'),
  finalResults: $('#finalResults'), shareText: $('#shareText'),
  shareXBtn: $('#shareXBtn'), copyShareTextBtn: $('#copyShareTextBtn'),
  playAgainBtn: $('#playAgainBtn'), openLeaderboardBtn: $('#openLeaderboardBtn'),
  lbFilters: $('#lbFilters'), leaderboardList: $('#leaderboardList'),
  playerDetailsModal: $('#playerDetailsModal'), closePlayerModal: $('#closePlayerModal'), playerDetailsBody: $('#playerDetailsBody'),
  openReportBtn: $('#openReportBtn'), reportModal: $('#reportModal'), closeReport: $('#closeReport'),
  reportType: $('#reportType'), reportDesc: $('#reportDesc'), reportImage: $('#reportImage'), reportAuto: $('#reportAuto'),
  sendReportBtn: $('#sendReportBtn')
};

/* ====== Utilities ====== */
function showScreen(key){ $$('.screen').forEach(s=>s.classList.remove('active')); screens[key].classList.add('active'); }
function toMinSec(sec){ sec = Math.round(+sec||0); const m=Math.floor(sec/60), s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
function uuid(prefix='PL'){ return prefix + Math.random().toString(36).slice(2,6).toUpperCase() + Date.now().toString(36).slice(-4).toUpperCase(); }
function getDeviceId(){ let d=localStorage.getItem('quizDeviceId'); if(!d){ d='D'+uuid('').slice(2); localStorage.setItem('quizDeviceId', d); } return d; }
function toast(m){ alert(m); }
function nextAttemptNumber(){ const k='quizAttemptCount'; let n=+(localStorage.getItem(k)||0); n+=1; localStorage.setItem(k, String(n)); return n; }

/* ====== Theme ====== */
(function initTheme(){
  let saved = localStorage.getItem('theme'); if(saved!=='light' && saved!=='dark') saved='dark';
  document.body.classList.toggle('theme-light', saved==='light');
  document.body.classList.toggle('theme-dark',  saved==='dark');
})();
els.themeToggle.addEventListener('click', ()=>{
  const isLight = document.body.classList.toggle('theme-light');
  document.body.classList.toggle('theme-dark', !isLight);
  localStorage.setItem('theme', isLight?'light':'dark');
});

/* ====== Init Avatars ====== */
function initAvatars(){
  const emojis = ['ğŸ™‚','ğŸ˜','ğŸ¤“','ğŸ§‘â€ğŸ’»','ğŸ§”','ğŸ‘©â€ğŸ¦±','ğŸ§‘â€ğŸ“','ğŸ§‘â€ğŸ¨','ğŸ§‘â€ğŸš€','ğŸ§‘â€ğŸš’'];
  els.avatarGrid.innerHTML = '';
  emojis.forEach(e=>{
    const d = document.createElement('div');
    d.className='avatar'; d.textContent=e;
    d.onclick = ()=>{ $$('.avatar',els.avatarGrid).forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); state.player.avatar=e; els.avatarNextBtn.disabled=false; };
    els.avatarGrid.appendChild(d);
  });
}

/* ====== HUD ====== */
function updateHUD(){
  els.hudScore.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${state.game.score}`;
  els.hudMistakes.textContent = `Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${state.game.wrong}/${CONFIG.MAX_WRONG}`;
  els.hudAvatar.textContent = state.player.avatar;
  els.hudName.textContent = state.player.name || 'â€”';
  els.skipCost.textContent = `(${state.game.skipCost})`;
}
function renderLevelDots(){
  els.levelDots.innerHTML=''; LEVEL_ORDER.forEach((k,i)=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=String(i+1); if(i===state.game.currentLevelIndex) s.style.outline='2px solid var(--accent)'; els.levelDots.appendChild(s); });
}

/* ====== Game Flow ====== */
const getLevelKey = ()=> LEVEL_ORDER[state.game.currentLevelIndex];
const getBucket   = ()=> state.questions[getLevelKey()] || [];

function startLevel(levelKey){
  if(levelKey && !state.ui.devMode){ toast('Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…ØªØ§Ø­ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ÙÙ‚Ø·'); return; }
  if(levelKey) state.game.currentLevelIndex = LEVEL_ORDER.indexOf(levelKey);

  state.game.questionIndex=0; state.game.usedFifty=false; state.game.usedFreeze=false; state.game.skipCost=20;
  renderLevelDots(); showScreen('game'); nextQuestion();
}
function nextQuestion(){
  const bucket=getBucket(); const total=LEVEL_COUNTS[getLevelKey()];
  if(state.game.questionIndex >= total){ showScreen('levelEnd'); return; }

  const q=bucket[state.game.questionIndex];
  els.levelBadge.textContent = LEVEL_LABEL[getLevelKey()];
  els.qCounter.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${state.game.questionIndex+1} Ù…Ù† ${total}`;
  els.questionText.textContent = q.q;
  els.options.innerHTML='';

  q.options.forEach((opt,i)=>{
    const b=document.createElement('button'); b.className='option'; b.textContent=opt;
    b.onclick = ()=> onAnswer(i, q.correct);
    els.options.appendChild(b);
  });

  if(state.game.usedFifty) applyFiftyToOptions(q.correct); // Ù„Ùˆ Ø³Ø¨Ù‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… 50:50
  startTimer(); updateHUD();
}
function onAnswer(chosen, correct){
  stopTimer(); markOptions(chosen, correct);
  const timeSpent = CONFIG.QUESTION_TIME - state.game.remaining; state.game.totalTimeSec += Math.max(0, timeSpent);

  const ok = (chosen === correct);
  if(ok){
    state.game.correct++; state.game.score += 100;
    if(state.game.remaining >= CONFIG.QUESTION_TIME/2) state.game.score += 50; // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³Ø±Ø¹Ø©
  }else{
    state.game.wrong++; state.game.score -= 50;
  }
  updateHUD();

  setTimeout(()=>{
    if(state.game.wrong >= CONFIG.MAX_WRONG){ finalizeAndShowResults('Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡'); }
    else { state.game.questionIndex++; nextQuestion(); }
  }, 600);
}
function markOptions(choice, correct){
  $$('.option', els.options).forEach((b,i)=>{ b.classList.add(i===correct?'correct':(i===choice?'wrong':'')); b.disabled=true; });
}

/* ====== Timer / Freeze ====== */
function startTimer(){
  state.game.remaining = CONFIG.QUESTION_TIME; els.timerBar.style.width='100%'; els.timerLabel.textContent=String(state.game.remaining);
  state.game.frozen = false;
  state.game.timer = setInterval(()=>{
    if(state.game.frozen) return;
    state.game.remaining--; els.timerLabel.textContent=String(state.game.remaining);
    els.timerBar.style.width = `${(state.game.remaining/CONFIG.QUESTION_TIME)*100}%`;
    if(state.game.remaining<=0){ clearInterval(state.game.timer); onAnswer(-1, getBucket()[state.game.questionIndex].correct); }
  },1000);
}
function stopTimer(){ clearInterval(state.game.timer); }

/* ====== Helpers ====== */
function applyFiftyToOptions(correctIdx){
  const ops=$$('.option',els.options); let removed=0;
  for(let i=0;i<ops.length && removed<2;i++){ if(i!==correctIdx && !ops[i].classList.contains('disabled')){ ops[i].classList.add('disabled'); ops[i].disabled=true; removed++; } }
}
els.btnFifty.onclick = ()=>{
  if(state.game.usedFifty) return toast('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… 50:50 Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
  state.game.usedFifty = true;
  const q=getBucket()[state.game.questionIndex]; applyFiftyToOptions(q.correct);
};
els.btnFreeze.onclick = ()=>{
  if(state.game.usedFreeze) return toast('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
  state.game.usedFreeze = true; state.game.frozen = true; let s=10;
  const tmp=setInterval(()=>{ s--; if(s<=0){ clearInterval(tmp); state.game.frozen=false; } },1000);
};
els.btnSkip.onclick = ()=>{
  state.game.score -= state.game.skipCost; state.game.skips++; state.game.skipCost += 20; stopTimer(); updateHUD();
  state.game.questionIndex++; nextQuestion();
};

/* ====== Level End / Results ====== */
els.btnNextLevel.onclick = ()=>{
  state.game.currentLevelIndex++;
  if(state.game.currentLevelIndex >= LEVEL_ORDER.length){ finalizeAndShowResults('Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª'); }
  else { startLevel(); }
};
els.btnWithdraw.onclick = ()=> finalizeAndShowResults('Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨');
els.playAgainBtn.onclick = ()=> location.reload();
els.openLeaderboardBtn.onclick = ()=> { showScreen('leaderboard'); refreshLeaderboard(); };
els.gotoLeaderboard.onclick = ()=> { showScreen('leaderboard'); refreshLeaderboard(); };

function finalizeAndShowResults(reason=''){
  const answered = state.game.correct + state.game.wrong;
  const accuracy = answered ? +(100*state.game.correct/answered).toFixed(1) : 0;
  const avg = answered ? Math.round(state.game.totalTimeSec/Math.max(1, answered)) : 0;
  const levelKey = getLevelKey();
  const rating = accuracy>=85 ? 'Ù…Ù…ØªØ§Ø²' : accuracy>=60 ? 'Ø¬ÙŠÙ‘Ø¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
  const attemptNumber = nextAttemptNumber();

  const stats = {
    name: state.player.name,
    playerId: state.player.playerId,
    attempt: attemptNumber,
    correct: state.game.correct,
    wrong: state.game.wrong,
    skips: state.game.skips,
    score: state.game.score,
    total: state.game.totalTimeSec,
    level: LEVEL_LABEL[levelKey],
    accuracy,
    avg,
    rating
  };

  showScreen('results'); renderResults(stats);

  if(CONFIG.APPS_SCRIPT_URL && CONFIG.APPS_SCRIPT_URL.startsWith('http')){
    sendToGAS('gameResult', stats).catch(()=>{});
    sendToGAS('log', {
      attemptNumber,
      deviceId: state.player.deviceId,
      playerId: state.player.playerId,
      name: state.player.name,
      correct: stats.correct, wrong: stats.wrong, accuracy: stats.accuracy,
      skips: stats.skips, usedFifty: state.game.usedFifty, usedFreeze: state.game.usedFreeze,
      score: stats.score, totalTimeSec: stats.total, avgTimeSec: stats.avg,
      lastLevel: levelKey, rating: stats.rating, createdAt: new Date().toISOString(), reason
    }).catch(()=>{});
  }

  if(supa){ // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµØ¯Ø§Ø±Ø©
    const isImpossibleFinisher = (levelKey==='impossible' && state.game.questionIndex>=LEVEL_COUNTS['impossible']);
    supa.from('leaderboard').upsert({
      device_id: state.player.deviceId,
      player_id: state.player.playerId,
      name: state.player.name,
      avatar: state.player.avatar,
      score: stats.score,
      level: levelKey,
      accuracy: stats.accuracy,
      total_time: stats.total,
      avg_time: stats.avg,
      correct_answers: stats.correct,
      wrong_answers: stats.wrong,
      skips: stats.skips,
      is_impossible_finisher: isImpossibleFinisher,
      updated_at: new Date().toISOString()
    }, { onConflict:'device_id' }).then(()=> refreshLeaderboard());
  }
}
function renderResults(s){
  const rows = [
    ['Ø§Ù„Ø§Ø³Ù…', s.name], ['Ø§Ù„Ù…Ø¹Ø±Ù‘Ù', s.playerId], ['Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', s.attempt],
    ['Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©', s.correct], ['Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©', s.wrong],
    ['Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ', s.skips], ['Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', s.score],
    ['Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚ (Ø¯.Ø«)', toMinSec(s.total)], ['Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡', s.level],
    ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©', `${s.accuracy}%`], ['Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¯.Ø«)', toMinSec(s.avg)],
    ['Ø£Ø¯Ø§Ø¤Ùƒ', s.rating]
  ];
  els.finalResults.innerHTML = rows.map(([k,v])=> `<div class="kv"><b>${k}:</b><div>${v}</div></div>`).join('');
  els.shareText.value = buildShareText(s);
}
function buildShareText(s){
  return `ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ†

Ø§Ù„Ø§Ø³Ù…: ${s.name}
Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ${s.playerId}
Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${s.attempt}
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${s.correct}
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${s.wrong}
Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ: ${s.skips}
Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${s.score}
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚ (Ø¯.Ø«): ${toMinSec(s.total)}
Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡: ${s.level}
Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©: ${s.accuracy}%
Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¯.Ø«): ${toMinSec(s.avg)}
Ø£Ø¯Ø§Ø¤Ùƒ: ${s.rating}`;
}
els.copyShareTextBtn.onclick = ()=>{ els.shareText.select(); document.execCommand('copy'); toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ'); };
els.shareXBtn.onclick = ()=>{ window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(els.shareText.value)}`,'_blank'); };

/* ====== Reports (GAS) ====== */
els.openReportBtn.onclick = ()=> els.reportModal.classList.remove('hidden');
els.closeReport.onclick = ()=> els.reportModal.classList.add('hidden');
els.sendReportBtn.onclick = async ()=>{
  const type=els.reportType.value, description=els.reportDesc.value.trim();
  let screenshot_b64=''; if(els.reportImage.files[0]) screenshot_b64 = await fileToBase64(els.reportImage.files[0]);
  const payload = {
    playerId: state.player.playerId, name: state.player.name, type, description,
    question_text: $('#questionText')?.textContent || '', user_agent: navigator.userAgent,
    screen_resolution: `${screen.width}x${screen.height}`, auto_detected: !!els.reportAuto.checked,
    screenshot_b64
  };
  if(CONFIG.APPS_SCRIPT_URL){ await sendToGAS('report', payload); toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!'); }
  els.reportModal.classList.add('hidden');
};
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]); r.onerror=rej; r.readAsDataURL(file); }); }
async function sendToGAS(type,data){
  const r = await fetch(CONFIG.APPS_SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ type, secretKey: CONFIG.TEST_KEY, data }) });
  return r.json();
}

/* ====== Supabase Leaderboard ====== */
let supa = null;
if(CONFIG.SUPABASE_URL && CONFIG.SUPABASE_KEY && window.supabase){
  supa = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
}
async function refreshLeaderboard(filter='all'){
  if(!supa){ $('#leaderboardList').innerHTML=`<div class="muted">Ù„Ù… ØªÙÙ‡ÙŠÙ‘Ø£ Supabase Ø¨Ø¹Ø¯.</div>`; return; }
  let q = supa.from('leaderboard').select('player_id,name,avatar,score,is_impossible_finisher').order('score',{ascending:false});
  if(filter==='top10') q=q.limit(10);
  if(filter==='impossible') q=q.eq('is_impossible_finisher', true);
  const { data, error } = await q;
  if(error){ $('#leaderboardList').innerHTML = `<div class="muted">Ø®Ø·Ø£: ${error.message}</div>`; return; }
  $('#leaderboardList').innerHTML = (data||[]).map((row,i)=>`
    <div class="row-item" data-player="${row.player_id}">
      <div class="rank">${i+1}</div>
      <div class="avatar">${row.avatar || 'ğŸ™‚'}</div>
      <div class="grow">
        <div><b>${row.name}</b></div>
        <div class="muted">Ø§Ù„Ù†Ù‚Ø§Ø·: ${row.score}${row.is_impossible_finisher ? ' Â· Ù…Ø³ØªØ­ÙŠÙ„ âœ…' : ''}</div>
      </div>
    </div>
  `).join('') || `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>`;
  $$('#leaderboardList .row-item').forEach(el=> el.onclick = ()=> openPlayerDetails(el.dataset.player) );
}
async function openPlayerDetails(playerId){
  if(!supa){ return; }
  const { data, error } = await supa.from('game_logs').select('*').eq('player_id', playerId).order('created_at',{ascending:false}).limit(25);
  if(error){ els.playerDetailsBody.innerHTML=`<div class="muted">Ø®Ø·Ø£: ${error.message}</div>`; }
  else{
    els.playerDetailsBody.innerHTML = (data||[]).map(x=>`
      <div class="row-item">
        <div class="grow">
          <div><b>${new Date(x.created_at).toLocaleString('ar')}</b></div>
          <div class="muted">Ù†Ù‚Ø§Ø·: ${x.score} Â· Ø¯Ù‚Ø©: ${x.accuracy}% Â· Ù…Ø³ØªÙˆÙ‰: ${x.level} Â· ØªØ®Ø·ÙŠ: ${x.skips}</div>
        </div>
      </div>
    `).join('') || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
  }
  els.playerDetailsModal.classList.remove('hidden');
}
els.closePlayerModal.onclick = ()=> els.playerDetailsModal.classList.add('hidden');
els.lbFilters.onclick = (e)=>{ const b=e.target.closest('.pill'); if(!b) return; $$('.pill',els.lbFilters).forEach(p=>p.classList.remove('active')); b.classList.add('active'); refreshLeaderboard(b.dataset.filter); };
setInterval(()=>{ if($('.screen.active')===screens.leaderboard){ const f=$('.pill.active',els.lbFilters)?.dataset.filter||'all'; refreshLeaderboard(f);} }, 60000);

/* ====== Navigation ====== */
$$('.back-btn').forEach(b=> b.addEventListener('click', ()=> showScreen(b.dataset.back.slice(1)) ));
els.openDevBtn.onclick = ()=>{ const p=prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±'); if(p!==CONFIG.DEV_PASSWORD) return toast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); state.ui.devMode=true; showScreen('levelSelect'); };
$('#screen-level-select').onclick = (e)=>{ const b=e.target.closest('.pill'); if(!b) return; startLevel(b.dataset.level); };
els.startBtn.onclick = ()=> showScreen('avatar');
els.avatarNextBtn.onclick = ()=> showScreen('name');
els.playerNameInput.oninput = ()=>{ const ok=validateName(els.playerNameInput.value); els.confirmNameBtn.disabled=!ok; };
els.confirmNameBtn.onclick = ()=>{
  const name = els.playerNameInput.value.trim(); if(!validateName(name)) return toast('Ø§Ù„Ø§Ø³Ù… Ø¨ÙŠÙ† 2 Ùˆ 25 Ø­Ø±ÙÙ‹Ø§');
  state.player.name=name; if(!state.player.playerId) state.player.playerId=uuid('PL'); if(!state.player.deviceId) state.player.deviceId=getDeviceId();
  showScreen('instructions');
};
els.startRoundBtn.onclick = ()=>{
  state.game.currentLevelIndex=0; state.game.score=CONFIG.STARTING_SCORE; state.game.correct=0; state.game.wrong=0;
  state.game.skips=0; state.game.skipCost=20; state.game.totalTimeSec=0; startLevel();
};
function validateName(n){ n=(n||'').trim(); return n.length>=2 && n.length<=25; }

/* ====== Bootstrap ====== */
(function bootstrap(){
  initAvatars(); updateHUD(); renderLevelDots();
})();
</script>
</body>
</html>
