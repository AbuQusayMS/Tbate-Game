// @ts-nocheck
/**
 * @fileoverview The enhanced back-end script for the quiz game
 * @author AbuQusay & Gemini
 * @version 6.1 - Syntax Bug Fix & Code Formatting
 */

// =================================================================
// ğŸ“š 1. CONFIGURATION
// =================================================================

class GameConfig {
  static get SHEET_ID() { return '1lFtM0HfdOjOF0ci-HGA2H82E7zJAofW1sC41P7lHyVE'; }
  static get ADMIN_NAME() { return 'AbuQusay'; }
  static get API_KEY_PROPERTY() { return 'API_KEY'; }
  static get MAX_LEADERBOARD_SIZE() { return 100; }
  static get GAME_URL() { return 'https://abuqusayms.github.io/Shadow-Game/'; }
  
  static get SHEETS() {
    return {
      LOG: 'Ø§Ù„Ø³Ø¬Ù„',
      LEADERBOARD: 'Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©',
      FINISHERS: 'Ø§Ù„Ù…Ù†Ø¬Ø²ÙˆÙ†',
      STATS: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
      DEVICE_GROUPS: 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©',
      AUDIT_LOG: 'Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª',
    };
  }
  
  static get HEADERS() {
    return {
      LOG: [
        'Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù„Ø§Ø¹Ø¨', 'Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨', 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©',
        'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©', 'Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… 50:50', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¯',
        'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯:Ø«)', 'Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª (Ø¯:Ø«)', 'Ø¢Ø®Ø± Ù…Ø³ØªÙˆÙ‰ ÙˆØµÙ„ Ø¥Ù„ÙŠÙ‡', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„'
      ],
      LEADERBOARD: ['Ø§Ù„ØªØ±ØªÙŠØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨', 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©'],
      FINISHERS: ['Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù„Ø§Ø¹Ø¨', 'Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', 'Ø§Ù„Ù†Ù‚Ø§Ø·'],
      DEVICE_GROUPS: ['Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ù„Ø¹Ø¨'],
      AUDIT_LOG: ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø§Ù„Ø­Ø§Ù„Ø©']
    };
  }
}


class TelegramConfig {
  static get BOT_TOKEN() { return PropertiesService.getScriptProperties().getProperty('TELEGRAM_BOT_TOKEN'); }
  static get CHAT_ID() { return PropertiesService.getScriptProperties().getProperty('TELEGRAM_CHAT_ID'); }
  static get isEnabled() { return this.BOT_TOKEN && this.CHAT_ID; }
}

// =================================================================
// ğŸŒ 2. MAIN ENTRY POINT (WEB APP)
// =================================================================

class GameAPI {
  static handleRequest(e) {
    const lock = LockService.getScriptLock();
    try {
      lock.waitLock(30000);
      if (!e.postData) throw new Error('Invalid request - no data');
      const data = JSON.parse(e.postData.contents);
      this._validateApiKey(data.apiKey);
      return this._routeRequest(data);
    } catch (error) {
      return this._handleError(error, e);
    } finally {
      lock.releaseLock();
    }
  }
  
  static _routeRequest(data) {
    GameLogger.audit(data.action, data, 'Started');
    let result;
    switch (data.action) {
      case 'endGame': result = GameSession.end(data); break;
      case 'getLeaderboard': result = Leaderboard.get(); break;
      case 'startGame': result = GameSession.start(data); break;
      case 'getStats': result = Statistics.get(); break;
      case 'updateDeviceGroups': DeviceManager.updateGroups(); result = { success: true, message: 'Device groups updated' }; break;
      case 'reportError': NotificationService.sendErrorReport(data.data); result = { success: true, message: 'Report received' }; break;
      default: throw new Error(`Unknown action: ${data.action}`);
    }
    GameLogger.audit(data.action, data, 'Success');
    return ResponseHelper.json(result);
  }
  
  static _validateApiKey(apiKey) {
    const storedKey = PropertiesService.getScriptProperties().getProperty(GameConfig.API_KEY_PROPERTY);
    if (!apiKey || apiKey !== storedKey) {
      GameLogger.audit('Authentication Failure', { providedKey: apiKey?.substring(0, 8) + '...' }, 'Failed');
      throw new Error('Invalid API Key');
    }
  }
  
  static _handleError(error, e) {
    const action = e.postData ? JSON.parse(e.postData.contents).action : 'Unknown';
    GameLogger.audit('System Error', { action, error: error.message }, 'Failed');
    if (!error.message.includes('API Key')) {
      NotificationService.sendErrorAlert(action, error.message);
    }
    return ResponseHelper.json({ success: false, error: error.message });
  }
}

// =================================================================
// ğŸ® 3. GAME SESSIONS
// =================================================================

class GameSession {
  static start(data) {
    DataValidator.validateStartData(data);
    if (this._isAdmin(data.name)) return { success: true, message: 'Admin access granted', isAdmin: true };
    return { success: true, message: 'Game session started' };
  }
  
  static end(data) {
    DataValidator.validateEndData(data);
    if (this._isAdmin(data.name)) return { success: true, message: 'Admin score not recorded', isAdmin: true };
    
    const attemptNumber = this._getNewAttemptNumber(data.deviceId);
    const fullGameData = { ...data, attemptNumber };

    if (fullGameData.isGameCompleted) {
        this._recordGameFinisher(fullGameData);
    }

    this._saveGameResult(fullGameData);
    Leaderboard.update(fullGameData);
    Statistics.update();
    NotificationService.sendGameResult(fullGameData);
    
    return { success: true, message: 'Score saved successfully' };
  }

  static _recordGameFinisher(data) {
    const finisherSheet = SheetManager.getSheet(GameConfig.SHEETS.FINISHERS, GameConfig.HEADERS.FINISHERS);
    const finisherIds = finisherSheet.getLastRow() > 1 ? finisherSheet.getRange(2, 1, finisherSheet.getLastRow() - 1, 1).getValues().flat() : [];
    
    if (!finisherIds.includes(data.playerId)) {
      finisherSheet.appendRow([data.playerId, data.name, new Date(), data.score]);
    }
  }

  static _getNewAttemptNumber(deviceId) {
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.LOG);
    if (sheet.getLastRow() < 2) return 1;
    const deviceIdColumn = sheet.getRange(2, 2, sheet.getLastRow() - 1, 1).getValues();
    const attemptNumberColumn = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
    for (let i = deviceIdColumn.length - 1; i >= 0; i--) {
      if (deviceIdColumn[i][0] === deviceId) {
        const lastAttempt = parseInt(attemptNumberColumn[i][0], 10);
        return isNaN(lastAttempt) ? 1 : lastAttempt + 1;
      }
    }
    return 1;
  }
  
  static _isAdmin(playerName) { return playerName.toLowerCase() === GameConfig.ADMIN_NAME.toLowerCase(); }
  
  static _saveGameResult(data) {
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.LOG, GameConfig.HEADERS.LOG);
    const newRow = [
      data.attemptNumber, data.deviceId, data.playerId, data.name, data.correct, data.wrong,
      data.accuracy, data.skips, data.usedFiftyFifty ? 1 : 0, data.usedFreezeTime ? 1 : 0,
      data.score, data.totalTime / 86400, data.avgTime / 86400, data.level, new Date()
    ];
    sheet.appendRow(newRow);
  }
}

// =================================================================
// ğŸ† 4. LEADERBOARD
// =================================================================

class Leaderboard {
  
  static get() {
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.LEADERBOARD, GameConfig.HEADERS.LEADERBOARD);
    if (sheet.getLastRow() < 2) return { success: true, leaderboard: [] };
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, GameConfig.HEADERS.LEADERBOARD.length + 2).getValues(); // Read hidden cols too
    let leaderboard = data.map(row => ({ 
      rank: row[0], 
      name: row[1], 
      level: row[2], 
      attempt: row[3],
      playerId: row[5] // PlayerID is hidden in column F
    }));
    
    return { success: true, leaderboard };
  }
  
  static update(gameData) {
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.LEADERBOARD, GameConfig.HEADERS.LEADERBOARD);
    let entries = [];
    const COLS_TO_READ = 6; // Rank, Name, Level, Attempt, Score (hidden), PlayerID (hidden)

    if (sheet.getLastRow() > 1) {
      const existingData = sheet.getRange(2, 2, sheet.getLastRow() - 1, COLS_TO_READ - 1).getValues();
      entries = existingData.map(row => ({
        name: row[0], level: row[1], attempt: row[2], score: row[3] || 0, playerId: row[4] || null
      }));
    }
    
    entries.push({ name: gameData.name, level: gameData.level, attempt: gameData.attemptNumber, score: gameData.score, playerId: gameData.playerId });
    entries.sort((a, b) => b.score - a.score); 
    
    if (sheet.getLastRow() > 1) {
      sheet.getRange(2, 1, sheet.getLastRow(), COLS_TO_READ).clearContent();
    }
    
    const finisherSheet = SheetManager.getSheet(GameConfig.SHEETS.FINISHERS);
    let ultimateWinnerId = null;
    if (finisherSheet.getLastRow() > 1) {
        ultimateWinnerId = finisherSheet.getRange(2, 1).getValue();
    }

    let winnerEntry = null;
    if (ultimateWinnerId) {
        const winnerIndex = entries.findIndex(e => e.playerId === ultimateWinnerId);
        if (winnerIndex > -1) {
            winnerEntry = entries.splice(winnerIndex, 1)[0];
        }
    }

    const finalEntries = (winnerEntry ? [winnerEntry, ...entries] : entries).slice(0, GameConfig.MAX_LEADERBOARD_SIZE);
      
    const dataToWrite = finalEntries.map((entry, index) => {
      let rank;
      if (winnerEntry && entry.playerId === winnerEntry.playerId) {
        rank = 'ğŸ–ï¸';
      } else {
        const numericRank = winnerEntry ? index : index + 1; // Adjust rank if winner is present
        rank = {1: 'ğŸ¥‡', 2: 'ğŸ¥ˆ', 3: 'ğŸ¥‰'}[numericRank] || numericRank;
      }
      return [rank, entry.name, entry.level, entry.attempt, entry.score, entry.playerId];
    });

    if (dataToWrite.length > 0) {
      sheet.getRange(2, 1, dataToWrite.length, COLS_TO_READ).setValues(dataToWrite);
    }
  }
}

// =================================================================
// ğŸ“¨ 8. NOTIFICATIONS
// =================================================================

class NotificationService {
  static sendGameResult(gameData) {
    if (!TelegramConfig.isEnabled) return;
    const { correct, wrong, name, playerId, skips, score, totalTime, level, avgTime } = gameData;
    const totalAnswered = correct + wrong;
    const accuracy = totalAnswered > 0 ? parseFloat(((correct / totalAnswered) * 100).toFixed(1)) : 0.0;
    
    let performanceRating = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„";
    if (totalAnswered > 0) {
        if (accuracy >= 90) performanceRating = "Ù…Ù…ØªØ§Ø² ğŸ†";
        else if (accuracy >= 75) performanceRating = "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ â­";
        else if (accuracy >= 60) performanceRating = "Ø¬ÙŠØ¯ ğŸ‘";
        else if (accuracy >= 40) performanceRating = "Ù…Ù‚Ø¨ÙˆÙ„ ğŸ‘Œ";
        else performanceRating = "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ“ˆ";
    }

    const resultsMessage = `ğŸ† <b>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</b> ğŸ†\n\n<b>Ø§Ù„Ø§Ø³Ù…:</b> <code>${this._escapeHtml(name)}</code>\n<b>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</b> <code>${this._escapeHtml(playerId)}</code>\n<b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${correct}\n<b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:</b> ${wrong}\n<b>Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ:</b> ${skips}\n<b>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</b> ${score}\n<b>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚:</b> ${TimeHelper.formatMinutesSeconds(totalTime)}\n<b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡:</b> ${level}\n<b>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©:</b> ${accuracy}%\n<b>Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</b> ${TimeHelper.formatMinutesSeconds(avgTime)} / Ø³Ø¤Ø§Ù„\n<b>Ø£Ø¯Ø§Ø¤Ùƒ:</b> ${performanceRating}`;
    const plainTextForSharing = `Ù†ØªØ§Ø¦Ø¬ÙŠ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ğŸ§ \n\nØ§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ù†Ù‚Ø§Ø·: ${score}\nØ§Ù„Ù…Ø³ØªÙˆÙ‰: ${level}\nØ£Ø¯Ø§Ø¤Ùƒ: ${performanceRating}\n\nØ¬Ø±Ø¨ ØªØ­Ø¯ÙŠÙƒ Ø£Ù†Øª Ø£ÙŠØ¶Ø§Ù‹!\n${GameConfig.GAME_URL}`;
    const encodedShareText = encodeURIComponent(plainTextForSharing);
    const shareOnXUrl = `https://twitter.com/intent/tweet?text=${encodedShareText}`;
    const adminReport = `ğŸ“‹ <b>ØªÙ‚Ø±ÙŠØ± Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯</b> ğŸ“‹\n\n<b>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:</b> ${gameData.attemptNumber}\n<b>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù‡Ø§Ø²:</b> <code>${this._escapeHtml(gameData.deviceId)}</code>\n<b>Ø§Ù„Ø§Ø³Ù…:</b> <code>${this._escapeHtml(name)}</code>\n<b>Ø§Ù„Ù†Ù‚Ø§Ø·:</b> ${score}\n<b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</b> ${level}`;
    const finalMessage = `${resultsMessage}\n\n<a href="${shareOnXUrl}"><b>Ø§Ù†Ø´Ø± Ø¹Ù„Ù‰ ğ•</b></a>\n<i>Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŒ Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ:</i>\n<code>${this._escapeHtml(plainTextForSharing)}</code>\n\nâ–â–â–â–â–â–â–â–â–â–\n\n${adminReport}`;
    this._sendTelegram(finalMessage);
  }
  
  static sendErrorReport(reportData) {
    if (!TelegramConfig.isEnabled) return;
    const { errorDetails = {}, gameState = {}, userAgent = 'N/A' } = reportData;
    const message = `ğŸ <b>Ø¨Ù„Ø§Øº Ø¨Ù…Ø´ÙƒÙ„Ø© ÙÙ†ÙŠØ©</b>\n\nğŸ‘¤ <b>Ø§Ù„Ù„Ø§Ø¹Ø¨:</b> <code>${this._escapeHtml(gameState.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</code>\n<b>--- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ---</b>\n<pre>${this._escapeHtml(JSON.stringify(errorDetails, null, 2))}</pre>\n<b>--- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ---</b>\n<pre>${this._escapeHtml(userAgent)}</pre>`;
    this._sendTelegram(message);
  }

  static sendErrorAlert(action, error) {
    if (!TelegramConfig.isEnabled) return;
    const message = `ğŸš¨ <b>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</b>\n\nğŸ› ï¸ <b>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</b> <code>${this._escapeHtml(action)}</code>\nâŒ <b>Ø§Ù„Ø®Ø·Ø£:</b> <code>${this._escapeHtml(error)}</code>`;
    this._sendTelegram(message);
  }
  
  static _sendTelegram(message) {
    try {
      const url = `https://api.telegram.org/bot${TelegramConfig.BOT_TOKEN}/sendMessage`;
      const options = { method: 'post', contentType: 'application/json', payload: JSON.stringify({ chat_id: TelegramConfig.CHAT_ID, text: message, parse_mode: 'HTML', disable_web_page_preview: true }), muteHttpExceptions: true };
      UrlFetchApp.fetch(url, options);
    } catch (error) {
      GameLogger.audit('Telegram Error', { error: error.message }, 'Failed');
    }
  }
  
  static _escapeHtml(text) {
    if (text == null) return '';
    return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }
}

// =================================================================
// ğŸ“„ 11. SHEET MANAGEMENT
// =================================================================

class SheetManager {
  static getSheet(sheetName, headers = []) {
    const ss = SpreadsheetApp.openById(GameConfig.SHEET_ID);
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      sheet.setRightToLeft(true);
      if (headers.length > 0) {
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
        const formatMap = { 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„': 'yyyy-mm-dd hh:mm:ss', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²': 'yyyy-mm-dd hh:mm:ss', 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯:Ø«)': '[mm]:ss', 'Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª (Ø¯:Ø«)': '[mm]:ss' };
        headers.forEach((h, i) => { if (formatMap[h]) sheet.getRange(2, i + 1, sheet.getMaxRows() - 1, 1).setNumberFormat(formatMap[h]); });
      }
    }
    return sheet;
  }
}

// =================================================================
// (The rest of the boilerplate classes are properly formatted below)
// =================================================================

class Statistics {
  static get() {
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.LOG);
    if (sheet.getLastRow() < 2) {
      return this._getEmptyStats();
    }
    // Correctly get the full range of data
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();
    return {
      success: true,
      stats: {
        totalPlays: data.length,
        uniqueDevices: this._countUniqueDevices(data),
        averageScore: this._calculateAverage(data, 10), // Column K
        averageAccuracy: this._calculateAverage(data, 6), // Column G
        lastUpdated: new Date()
      }
    };
  }
  static update() {
    const stats = this.get().stats;
    const sheet = SheetManager.getSheet(GameConfig.SHEETS.STATS);
    const data = [
      ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', stats.totalPlays],
      ['Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙØ±ÙŠØ¯Ø©', stats.uniqueDevices],
      ['Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù‚Ø§Ø·', Math.round(stats.averageScore)],
      ['Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚Ø©', stats.averageAccuracy.toFixed(1) + '%'],
      ['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«', stats.lastUpdated]
    ];
    sheet.clear();
    sheet.getRange(1, 1, 1, 2).setValues([
      ['Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©', 'Ø§Ù„Ù‚ÙŠÙ…Ø©']
    ]).setFontWeight('bold');
    sheet.getRange(2, 1, data.length, 2).setValues(data);
  }
  static _countUniqueDevices(data) {
    return new Set(data.map(row => row[1])).size;
  }
  static _calculateAverage(data, colIndex) {
    const values = data.map(row => parseFloat(row[colIndex]) || 0);
    const sum = values.reduce((acc, val) => acc + val, 0);
    return values.length > 0 ? sum / values.length : 0;
  }
  static _getEmptyStats() {
    return { success: true, stats: { totalPlays: 0, uniqueDevices: 0, averageScore: 0, averageAccuracy: 0, lastUpdated: new Date() } };
  }
}

class DeviceManager {
  static updateGroups() {
    const logSheet = SheetManager.getSheet(GameConfig.SHEETS.LOG);
    const deviceSheet = SheetManager.getSheet(GameConfig.SHEETS.DEVICE_GROUPS, GameConfig.HEADERS.DEVICE_GROUPS);
    if (logSheet.getLastRow() < 2) {
      deviceSheet.clear();
      deviceSheet.getRange(1, 1, 1, 3).setValues([GameConfig.HEADERS.DEVICE_GROUPS]).setFontWeight('bold');
      return;
    }
    const logData = logSheet.getRange(2, 1, logSheet.getLastRow() - 1, logSheet.getLastColumn()).getValues();
    const deviceMap = new Map();
    logData.forEach(row => {
      const deviceId = row[1];
      if (!deviceMap.has(deviceId)) {
        deviceMap.set(deviceId, []);
      }
      deviceMap.get(deviceId).push({
        date: new Date(row[14]),
        name: row[3],
        score: row[10]
      });
    });
    const outputRows = [];
    deviceMap.forEach((attempts, deviceId) => {
      attempts.sort((a, b) => b.date - a.date);
      outputRows.push([deviceId, attempts.length, attempts[0].date]);
      attempts.slice(0, 5).forEach(attempt => {
        outputRows.push(['', `â†’ ${attempt.date.toLocaleString('ar-EG')}`, `Ø§Ù„Ù„Ø§Ø¹Ø¨: ${attempt.name}`, `Ø§Ù„Ù†Ù‚Ø§Ø·: ${attempt.score}`]);
      });
      if (attempts.length > 5) {
        outputRows.push(['', `... Ùˆ ${attempts.length - 5} Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰`, '', '']);
      }
    });
    deviceSheet.clear();
    deviceSheet.getRange(1, 1, 1, 4).setValues([GameConfig.HEADERS.DEVICE_GROUPS]).setFontWeight('bold');
    if (outputRows.length > 0) {
      deviceSheet.getRange(2, 1, outputRows.length, 4).setValues(outputRows);
    }
  }
}

class DataValidator {
  static validateStartData(data) { const r = ['playerId', 'name', 'deviceId']; this._checkRequiredFields(data, r); this._validateName(data.name); }
  static validateEndData(data) { const r = ['playerId', 'name', 'deviceId', 'score', 'level', 'accuracy']; this._checkRequiredFields(data, r); this._validateName(data.name); this._validateScore(data.score); this._validateAccuracy(data.accuracy); }
  static _checkRequiredFields(data, required) { const m = required.filter(f => !data.hasOwnProperty(f)); if (m.length > 0) { throw new Error(`Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù†Ø§Ù‚ØµØ©: ${m.join(', ')}`); } }
  static _validateName(name) { if (typeof name !== 'string' || name.trim().length === 0) { throw new Error('Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­'); } if (name.length > 50) { throw new Error('Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹'); } }
  static _validateScore(score) { if (typeof score !== 'number' || score < -100000 || score > 100000) { throw new Error('Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); } }
  static _validateAccuracy(accuracy) { if (typeof accuracy !== 'number' || accuracy < 0 || accuracy > 100) { throw new Error('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); } }
}

class GameLogger {
  static audit(action, data, status) {
    try {
      const sheet = SheetManager.getSheet(GameConfig.SHEETS.AUDIT_LOG, GameConfig.HEADERS.AUDIT_LOG);
      const entry = [new Date(), action, JSON.stringify(data), status];
      sheet.appendRow(entry);
      if (sheet.getLastRow() > 5000) {
        sheet.deleteRow(2);
      }
    } catch (error) {
      console.error('ÙØ´Ù„ ÙƒØªØ§Ø¨Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚:', error);
    }
  }
}

class ResponseHelper {
  static json(data) {
    return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
  }
}

class TimeHelper {
  static formatMinutesSeconds(seconds) {
    if (typeof seconds !== 'number' || isNaN(seconds)) {
      return '0:00';
    }
    const total = Math.round(seconds);
    const mins = Math.floor(total / 60);
    const secs = total % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
}

function doPost(e) { return GameAPI.handleRequest(e); }
function doGet(e) { return ResponseHelper.json({ status: 'active', version: '6.1' }); }

