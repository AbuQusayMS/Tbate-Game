<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª - Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©">
    <title>ğŸ§  Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª | Ø§Ø®ØªØ¨Ø± Ù‚Ø¯Ø±Ø§ØªÙƒ</title>

    <link rel="icon" type="image/png" href="/images/my-icon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
    :root {
      /* Dark Theme Colors */
      --color-dark-bg: #1a1a2e;
      --color-dark-primary: #16213e;
      --color-dark-secondary: #0f3460;
      --color-dark-accent: #e94560;
      --color-dark-text: #f0f0f0;
      --color-dark-border: #374151;
      --color-dark-gold: #ffd700;
      --color-dark-success: #10b981;
      --color-dark-error: #ef4444;

      /* Light Theme Colors */
      --color-light-bg: #f8fafc;
      --color-light-primary: #ffffff;
      --color-light-secondary: #e2e8f0;
      --color-light-accent: #2563eb;
      --color-light-text: #1e293b;
      --color-light-border: #cbd5e1;
      --color-light-gold: #ca8a04;
      --color-light-success: #059669;
      --color-light-error: #dc2626;

      /* Neutral Colors */
      --color-white: #ffffff;
      --color-black: #000000;
      --color-gray-500: #6b7280;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* Typography */
      --font-family: 'Cairo', sans-serif;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.575rem;

      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;

      /* Radius */
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-2xl: 1rem;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 300ms ease;
      
      /* Level Colors */
      --level-easy: #10b981;
      --level-medium: #3b82f6;
      --level-hard: #f59e0b;
      --level-impossible: #ef4444;
    }

    body[data-theme='dark'] {
      --bg-color: var(--color-dark-bg);
      --primary-color: var(--color-dark-primary);
      --secondary-color: var(--color-dark-secondary);
      --accent-color: var(--color-dark-accent);
      --text-color: var(--color-dark-text);
      --border-color: var(--color-dark-border);
      --gold-color: var(--color-dark-gold);
      --success-color: var(--color-dark-success);
      --error-color: var(--color-dark-error);
    }

    body[data-theme='light'] {
      --bg-color: var(--color-light-bg);
      --primary-color: var(--color-light-primary);
      --secondary-color: var(--color-light-secondary);
      --accent-color: var(--color-light-accent);
      --text-color: var(--color-light-text);
      --border-color: var(--color-light-border);
      --gold-color: var(--color-light-gold);
      --success-color: var(--color-light-success);
      --error-color: var(--color-light-error);
    }

    /* Level-specific styles */
    body[data-level="easy"] {
      --level-color: var(--level-easy);
      --level-bg: rgba(16, 185, 129, 0.1);
    }

    body[data-level="medium"] {
      --level-color: var(--level-medium);
      --level-bg: rgba(59, 130, 246, 0.1);
    }

    body[data-level="hard"] {
      --level-color: var(--level-hard);
      --level-bg: rgba(245, 158, 11, 0.1);
    }

    body[data-level="impossible"] {
      --level-color: var(--level-impossible);
      --level-bg: rgba(239, 68, 68, 0.1);
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      min-height: 100%;
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center; /* Reverted to 'center' for default vertical centering */
      align-items: center;
      padding: var(--space-8) var(--space-4);
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
      transition: opacity var(--transition-normal), visibility var(--transition-normal), transform var(--transition-normal);
      overflow-y: auto;
      z-index: 1;
    }

    /* New class for screens that need to scroll and align to top */
    .screen.screen--align-top {
        justify-content: flex-start;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
      z-index: 10;
    }

    .content-box {
      background-color: var(--primary-color);
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      width: 100%;
      max-width: 30rem;
      box-shadow: var(--shadow-xl);
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .screen-header {
      margin-bottom: var(--space-6);
    }

    .game-title {
      font-size: var(--font-size-3xl);
      font-weight: 900;
      color: var(--gold-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .game-subtitle {
      color: var(--text-color);
      opacity: 0.8;
      margin-top: var(--space-2);
      font-size: 0.9rem;
    }

    h2 {
      font-size: var(--font-size-2xl);
      font-weight: 700;
    }

    h3 {
      font-size: var(--font-size-xl);
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      margin-top: var(--space-6);
    }

    .btn-main {
      background-color: var(--gold-color);
      color: var(--color-black);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: var(--font-size-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid var(--gold-color);
      box-shadow: var(--shadow-md);
    }
    .btn-main:hover:not(:disabled) {
      background-color: transparent;
      color: var(--gold-color);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: var(--text-color);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: var(--font-size-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid var(--border-color);
    }
    .btn-secondary:hover:not(:disabled) {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--color-white);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .input-group {
      margin-bottom: var(--space-6);
    }
    input[type="text"] {
      width: 100%;
      padding: var(--space-3);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: var(--font-size-base);
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
    }
    .error-message {
      color: var(--error-color);
      text-align: right;
      font-size: 0.875rem;
      margin-top: var(--space-2);
      display: none;
    }
    .error-message.show {
      display: block;
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .avatar-option {
      width: 80%;
      aspect-ratio: 1/1;
      border-radius: var(--radius-full);
      object-fit: cover;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all var(--transition-fast);
    }
    .avatar-option:hover {
      transform: scale(1.05);
    }
    .avatar-option.selected {
      border-color: var(--gold-color);
      transform: scale(1.1);
    }

    .instructions-content {
      text-align: right;
      margin: var(--space-6) 0;
    }
    .instruction-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: var(--space-4);
      gap: var(--space-3);
    }
    .instruction-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    .instruction-text {
      text-align: right;
    }
    .instructions-content a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 700;
    }
    .instructions-content a:hover {
      text-decoration: underline;
    }

    #gameContainer {
      justify-content: flex-start;
      padding: var(--space-4);
      width: 100%;
      max-width: 900px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      width: 100%;
    }
    .end-quiz-btn {
      background-color: var(--error-color);
      color: var(--color-white);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      font-weight: 700;
    }
    .level-progress {
      display: flex;
      gap: var(--space-2);
    }
    .level-indicator {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 2px solid var(--border-color);
      background-color: var(--secondary-color);
      color: var(--text-color);
      position: relative;
    }
    .level-indicator.active {
      background-color: var(--level-color);
      color: var(--color-white);
      border-color: var(--level-color);
    }
    .level-indicator[data-level="easy"].active {
      background-color: var(--level-easy);
      border-color: var(--level-easy);
    }
    .level-indicator[data-level="medium"].active {
      background-color: var(--level-medium);
      border-color: var(--level-medium);
    }
    .level-indicator[data-level="hard"].active {
      background-color: var(--level-hard);
      border-color: var(--level-hard);
    }
    .level-indicator[data-level="impossible"].active {
      background-color: var(--level-impossible);
      border-color: var(--level-impossible);
    }
    .level-indicator[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -2.5rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--primary-color);
      color: var(--text-color);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
      z-index: 100;
      border: 1px solid var(--border-color);
    }
    .level-indicator[data-tooltip]:hover::after {
      opacity: 1;
      visibility: visible;
    }
    .theme-toggle-btn {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-3);
      color: var(--text-color);
      cursor: pointer;
    }
    .game-header {
      display: flex;
      flex-direction: column;
      padding: var(--space-4);
      background-color: var(--primary-color);
      border-radius: var(--radius-xl);
      width: 100%;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-md);
    }
    .player-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .player-main {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    #playerAvatar {
      width: 3.5rem;
      height: 3.5rem;
      border-radius: var(--radius-full);
      border: 2px solid var(--gold-color);
    }
    .player-details {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #playerName {
      font-size: var(--font-size-lg);
      font-weight: 700;
    }
    .player-id {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .player-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-1);
      font-size: 0.875rem;
    }

    .player-stats strong {
      color: var(--gold-color);
    }

    .helpers {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3);
    }

    .helper-btn {
      padding: var(--space-2);
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .helper-cost {
      font-size: 0.75rem;
      font-weight: bold;
      color: var(--gold-color);
      margin-top: var(--space-1);
    }
    .helper-btn:not(:disabled):hover {
      background-color: var(--accent-color);
      color: var(--color-white);
    }

    .timer-container {
        width: 100%;
        background-color: var(--secondary-color);
        border-radius: var(--radius-full);
        margin: var(--space-4) 0;
        position: relative;
        height: 2rem;
        min-height: 2rem;
        flex-shrink: 0;
        overflow: hidden;
        border: 2px solid var(--border-color);
    }
    .timer-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--gold-color));
      border-radius: var(--radius-full);
      transition: width 1s linear;
      width: 100%;
    }
    .timer-bar.frozen {
        background: #3b82f6;
    }
    .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--color-white);
      font-weight: 700;
      text-shadow: 1px 1px 2px var(--color-black);
    }

    .main-content {
      width: 100%;
    }
    .question-box {
      background-color: var(--primary-color);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-md);
      text-align: center;
      position: relative;
    }
    .level-badge {
      position: absolute;
      top: -0.75rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--level-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-weight: bold;
      font-size: 0.875rem;
    }
    #questionCounter {
      color: var(--gold-color);
      font-size: var(--font-size-lg);
    }
    #questionText {
      font-size: var(--font-size-xl);
      font-weight: 600;
      line-height: 1.5;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }
    .option-btn {
      padding: var(--space-4);
      background-color: var(--primary-color);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-xl);
      color: var(--text-color);
      font-size: var(--font-size-base);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }
    .option-btn:hover:not(.disabled) {
      background-color: var(--secondary-color);
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }
    .option-btn.correct {
      background-color: var(--success-color);
      color: var(--color-white);
      border-color: var(--success-color);
    }
    .option-btn.wrong {
      background-color: var(--error-color);
      color: var(--color-white);
      border-color: var(--error-color);
    }
    .option-btn.disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    .option-btn.hidden {
      visibility: hidden;
      opacity: 0;
    }

    .level-stats {
      text-align: right;
      margin-bottom: var(--space-6);
    }
    .level-stats p {
      margin-bottom: var(--space-3);
    }
    .level-stats strong {
      color: var(--gold-color);
    }

    .final-stats {
      text-align: right;
      margin-bottom: var(--space-6);
    }
    .final-stats p {
      margin-bottom: var(--space-3);
      font-size: var(--font-size-lg);
    }
    .final-stats strong {
      color: var(--gold-color);
    }
    .performance-rating {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--border-color);
    }
    .share-section {
      margin-top: var(--space-6);
      border-top: 1px solid var(--border-color);
      padding-top: var(--space-6);
    }
    .share-buttons {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      margin-top: var(--space-4);
    }
    .share-btn {
      border: none;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      color: var(--color-white);
      font-weight: 700;
      cursor: pointer;
      font-size: var(--font-size-base);
    }
    .share-btn.x {
      background-color: var(--color-black);
    }
    .share-btn.instagram {
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: var(--primary-color);
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      width: 90%;
      max-width: 30rem;
      text-align: center;
      box-shadow: var(--shadow-xl);
    }
    .modal-buttons {
      display: flex;
      gap: var(--space-4);
      justify-content: center;
      margin-top: var(--space-6);
    }

    .toast-container {
      position: fixed;
      top: var(--space-4);
      left: var(--space-4);
      right: var(--space-4);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-3);
    }
    .toast {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      color: var(--color-white);
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    }
    .toast.success { background-color: var(--success-color); }
    .toast.error { background-color: var(--error-color); }

    @keyframes toastIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes toastOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    .spinner {
      width: 2.5rem;
      height: 2.5rem;
      border: 4px solid var(--secondary-color);
      border-top: 4px solid var(--gold-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .report-fab {
      position: fixed;
      bottom: var(--space-4);
      left: var(--space-4);
      width: 3.5rem;
      height: 3.5rem;
      background-color: var(--gold-color);
      color: var(--color-black);
      border-radius: var(--radius-full);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      z-index: 999;
      transition: transform var(--transition-fast);
    }
    .report-fab:hover {
      transform: scale(1.1);
    }

    @media (min-width: 768px) {
      .screen {
          padding: var(--space-8);
      }
      .button-group {
        flex-direction: row;
        justify-content: center;
      }
      .game-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .player-info {
          flex-grow: 1;
      }
      .player-stats {
        flex-direction: row;
        gap: var(--space-6);
        background: none;
        padding: 0;
      }
      .options-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* 1. ØªØ¹Ø±ÙŠÙ Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù† Ù†ÙØ³Ù‡Ø§ */
    @keyframes avatar-click-animation {
      0% {
        transform: scale(1.1); /* Ø§Ù„Ø­Ø¬Ù… Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù† (Ù†ÙØ³ Ø­Ø¬Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±) */
      }
      50% {
        transform: scale(1.25); /* Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù† (Ø§Ù„Ù†Ø¨Ø¶Ø©) */
      }
      100% {
        transform: scale(1.1);
      }
    }

    /* 2. ÙƒÙ„Ø§Ø³ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù† Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø¹Ù†ØµØ± */
    .avatar-option.clicked {
      animation: avatar-click-animation 300ms ease-out;
    }
        
    </style>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "VideoGame",
        "name": "ğŸ§  Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
        "description": "Ù„Ø¹Ø¨Ø© Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©",
        "applicationCategory": "GameApplication",
        "operatingSystem": "Web Browser",
        "author": {
            "@type": "Organization",
            "name": "Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©"
        }
    }
    </script>
</head>
<body data-theme="dark" aria-live="polite" data-level="easy">
    <div id="toast-container" class="toast-container" aria-live="assertive"></div>
    <div id="reportErrorFab" class="report-fab" role="button" aria-label="Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©">âš ï¸</div>

    <div id="loader" class="screen active" role="status" aria-label="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„">
        <div class="spinner" aria-hidden="true"></div>
        <span class="sr-only">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</span>
    </div>

    <div id="startScreen" class="screen" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h1 class="game-title">
                    <span aria-hidden="true">ğŸ§ </span>
                    Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                    <span class="sr-only">Ù„Ø¹Ø¨Ø© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                </h1>
                <p class="game-subtitle">Ø§Ø®ØªØ¨Ø± Ù‚Ø¯Ø±Ø§ØªÙƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø´ÙŠÙ‚Ø©</p>
            </header>
            
            <div class="button-group">
                <button id="startPlayBtn" class="btn-main">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
                </button>
                <button id="showLeaderboardBtn" class="btn-secondary">
                    Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©
                </button>
            </div>
        </div>
    </div>
    
    <div id="avatarScreen" class="screen" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2>Ø§Ø®ØªØ± ØµÙˆØ±ØªÙƒ Ø§Ù„Ø±Ù…Ø²ÙŠØ©</h2>
            </header>
            
            <div class="avatar-grid" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ù…Ø²ÙŠØ©">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>
            
            <div class="button-group">
                <button id="confirmAvatarBtn" class="btn-main" disabled>
                    Ø§Ù„ØªØ§Ù„ÙŠ
                    <span class="sr-only">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
                </button>
            </div>
        </div>
    </div>

    <div id="nameEntry" class="screen" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</h2>
            </header>
            
            <div class="input-group">
                <label for="nameInput" class="sr-only">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
                <input  
                    type="text"  
                    id="nameInput"  
                    placeholder="Ù…Ø«Ù„Ø§: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡"  
                    maxlength="25"  
                    autocomplete="name"
                    aria-required="true"
                >
                <div id="nameError" class="error-message" aria-live="polite"></div>
            </div>
            
            <div class="button-group">
                <button id="confirmNameBtn" class="btn-main">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù…
                </button>
            </div>
        </div>
    </div>
    
    
    <div id="instructionsScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            </header>
            
            <div class="instructions-content">
                <div class="instruction-item">
                    <span class="instruction-icon">âš–ï¸</span>
                    <div class="instruction-text">
                        <strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·:</strong><br>
                        âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: +100 Ù†Ù‚Ø·Ø©<br>
                        âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: -100 Ù†Ù‚Ø·Ø©
                    </div>
                </div>

                <div class="instruction-item">
                    <span class="instruction-icon">â±ï¸</span>
                    <div class="instruction-text">
                        <strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚Øª:</strong> Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯ ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø®Ù„Ø§Ù„Ù‡.
                    </div>
                </div>
                
                <div class="instruction-item">
                    <span class="instruction-icon">ğŸ› ï¸</span>
                    <div class="instruction-text">
                        <strong>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚ØªØŒ Ù…Ù‚Ø§Ø¨Ù„ 100 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ Ù…Ø³Ø§Ø¹Ø¯Ø©.
                    </div>
                </div>

                <div class="instruction-item">
                    <span class="instruction-icon">ğŸ¯</span>
                    <div class="instruction-text">
                        <strong>Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª:</strong> Ø£Ø±Ø¨Ø¹Ø© Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø©: Ø³Ù‡Ù„ØŒ Ù…ØªÙˆØ³Ø·ØŒ ØµØ¹Ø¨ØŒ ÙˆÙ…Ø³ØªØ­ÙŠÙ„.
                    </div>
                </div>

                <div class="instruction-item">
                    <span class="instruction-icon">ğŸš«</span>
                    <div class="instruction-text">
                        <strong>Ø­Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</strong> ÙŠÙØ³Ù…Ø­ Ù„Ùƒ Ø¨Ù€ 3 Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.
                    </div>
                </div>
                
                <div class="instruction-item">
                    <span class="instruction-icon">ğŸ“©</span>
                    <div class="instruction-text">
                        <strong>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:</strong> Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø¨Ø±
                        <a href="https://x.com/_MS_AbuQusay?t=Tv0klH2PdnBYFHj_G8uIEA&s=09" target="_blank" rel="noopener noreferrer">Ø¥ÙƒØ³</a> Ø£Ùˆ 
                        <a href="https://www.instagram.com/_ms_abuqusay?igsh=OTRmODR1cTNkcXV1">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a>.
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="instructionsConfirmBtn" class="btn-main">Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª</button>
            </div>
        </div>
    </div>

    <main id="gameContainer" class="screen" aria-hidden="true">
        <div class="top-bar">
            <button id="endQuizBtn" class="end-quiz-btn" aria-label="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
                ğŸšª Ø¥Ù†Ù‡Ø§Ø¡
            </button>
            
            <div class="level-progress">
                <div class="level-indicator" data-level="easy" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„">
                    <span>1</span>
                </div>
                <div class="level-indicator" data-level="medium" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·">
                    <span>2</span>
                </div>
                <div class="level-indicator" data-level="hard" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨">
                    <span>3</span>
                </div>
                <div class="level-indicator" data-level="impossible" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„">
                    <span>4</span>
                </div>
            </div>
            
            <button class="theme-toggle-btn" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø·ÙˆØ¹ ÙˆØ§Ù„Ø¸Ù„Ø§Ù…">
                <span aria-hidden="true">â˜€ï¸</span>
            </button>
        </div>
        
        <header class="game-header">
            <div class="player-info">
                <div class="player-main">
                    <img id="playerAvatar" src="" alt="" aria-hidden="true">
                    <div class="player-details">
                        <span id="playerName" aria-label="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"></span>
                        <span id="playerId" class="player-id"></span>
                    </div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">Ø§Ù„Ù†Ù‚Ø§Ø·: <strong id="currentScore" aria-live="polite">100</strong></div>
                    <div class="stat-item">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <strong id="wrongAnswersCount" aria-live="assertive">0 / 3</strong></div>
                    <div class="stat-item">Ø§Ù„ØªØ®Ø·ÙŠ: <strong id="skipCount">0</strong></div>
                </div>
            </div>

            <div class="helpers" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©">
                <button class="helper-btn" data-type="fiftyFifty" aria-describedby="fiftyFiftyDesc">
                    50:50
                    <span class="helper-cost">(100)</span>
                </button>
                <div id="fiftyFiftyDesc" class="sr-only">ÙŠØ²ÙŠÙ„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø®Ø§Ø·Ø¦ÙŠÙ†</div>
        
                <button class="helper-btn" data-type="freezeTime" aria-describedby="freezeTimeDesc">
                                â„ï¸ 10Ø«
                    <span class="helper-cost">(100)</span>
                </button>
                <div id="freezeTimeDesc" class="sr-only">ÙŠÙˆÙ‚Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†</div>

                <button class="helper-btn" data-type="skipQuestion" aria-describedby="skipQuestionDesc">
                    â­ï¸ ØªØ®Ø·ÙŠ
                    <span id="skipCost" class="helper-cost">(100)</span>
                </button>
                <div id="skipQuestionDesc" class="sr-only">ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            </div>
        </header>

        <div class="timer-container" aria-label="Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„">
            <div class="timer-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100"></div>
            <span id="timer" class="timer-text">30</span>
        </div>

        <div class="main-content">
            <section class="question-box" aria-labelledby="questionCounter">
                <div class="level-badge" id="currentLevelBadge">Ø³Ù‡Ù„</div>
                <h3 id="questionCounter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 5</h3>
                <p id="questionText" aria-live="polite"></p>
            </section>
            
            <section class="options-container" aria-labelledby="questionText">
                <div class="options-grid" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"></div>
            </section>
        </div>
    </main>

    <div id="levelCompleteScreen" class="screen" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2 id="levelCompleteTitle">ğŸ‰ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„!</h2>
            </header>
            
            <div class="level-stats">
                <p>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong id="levelScore"></strong></p>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <strong id="levelErrors"></strong></p>
                <p>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong id="levelCorrect"></strong></p>
            </div>
            
            <div class="button-group">
                <button id="nextLevelBtn" class="btn-main">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="quitLevelBtn" class="btn-secondary">Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2>ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ†</h2>
            </header>
            
            <div class="final-stats" aria-labelledby="finalStatsHeading">
                <h3 id="finalStatsHeading" class="sr-only">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                <p>âœï¸ Ø§Ù„Ø§Ø³Ù…: <strong id="finalName"></strong></p>
                <p>ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: <strong id="finalId"></strong></p>
                <p>âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong id="finalCorrect"></strong></p>
                <p>âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: <strong id="finalWrong"></strong></p>
                <p>â­ï¸ Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ: <strong id="finalSkips"></strong></p>
                <p>â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <strong id="finalScore"></strong></p>
                <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <strong id="totalTime"></strong></p>
                <p>ğŸ“ˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡: <strong id="finalLevel"></strong></p>            
                <p>ğŸ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©: <strong id="finalAccuracy"></strong></p>
                <p>ğŸ”¥ Ø£ÙØ¶Ù„ Ø³Ù„Ø³Ù„Ø© Ù…ØªØªØ§Ù„ÙŠØ©: <strong id="finalBestStreak"></strong></p>
                <p>â³ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: <strong id="finalAvgTime"></strong></p>
    
                <div class="performance-rating">
                    <span>Ø£Ø¯Ø§Ø¤Ùƒ: </span>
                    <strong id="performanceText"></strong>
                </div>
            </div>
            
            <section class="share-section" aria-labelledby="shareHeading">
                <h3 id="shareHeading">ğŸ“¢ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <div class="share-buttons">
                    <button id="shareXBtn" class="share-btn x" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ X">
                        X
                    </button>
                    <button id="shareInstagramBtn" class="share-btn instagram" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ Instagram">
                        Instagram
                    </button>
                </div>
            </section>
            
            <div class="button-group">
                <button id="playAgainBtn" class="btn-main">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
                <button id="statsBtn" class="btn-secondary">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
            </div>
        </div>
    </div>
    
    <div id="leaderboardScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <header class="screen-header">
                <h2>
                    <span aria-hidden="true">ğŸ†</span>
                    Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©
                    <span aria-hidden="true">ğŸ†</span>
                </h2>
            </header>
            
            <div id="leaderboardContent" aria-live="polite">
            </div>
            
            <div class="button-group">
                <button id="backToStartBtn" class="btn-secondary">
                    Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
            </div>
        </div>
    </div>

    <div id="confirmExitModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <p>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</p>
            <div class="modal-buttons">
                <button id="confirmExitYes" class="btn-main">Ù†Ø¹Ù…</button>
                <button id="confirmExitNo" class="btn-secondary">Ù„Ø§</button>
            </div>
        </div>
    </div>
    
    <div id="reportErrorModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <h3>Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h3>
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ÙˆØ§Ø¬Ù‡ØªÙ‡Ø§ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
            <div id="lastErrorMessage" style="font-family: monospace; background: var(--secondary-color); padding: 8px; border-radius: 8px; margin-top: 1rem; direction: ltr; text-align: left; display: none;"></div>
            <div class="modal-buttons">
                <button id="confirmReportYes" class="btn-main">Ù†Ø¹Ù…ØŒ Ø£Ø±Ø³Ù„</button>
                <button id="confirmReportNo" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

<script>
    class QuizGame {
        constructor() {
            // =================================================================
            // !!!  ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©  !!!
            // =================================================================
            this.API_URL = "https://script.google.com/macros/s/AKfycbwSieydP8pgaTKpqzlDBYDEjeuMSYu85eVLwUlMepwkbGOi4toI5-Lc-lpeK8T6rRdg/exec";
            this.API_KEY = "AbuQusay2025_SecretKey";
            // =================================================================

            this.QUESTION_TIME = 80;
            this.MAX_WRONG_ANSWERS = 3;
            this.STARTING_SCORE = 100;

            this.LEVELS = [
                { name: "easy", label: "Ø³Ù‡Ù„", color: "#10b981" },
                { name: "medium", label: "Ù…ØªÙˆØ³Ø·", color: "#3b82f6" },
                { name: "hard", label: "ØµØ¹Ø¨", color: "#f59e0b" },
                { name: "impossible", label: "Ù…Ø³ØªØ­ÙŠÙ„", color: "#ef4444" }
            ];

            this.QUESTIONS = {};

            this.HELPER_COSTS = {
                fiftyFifty: 100,
                freezeTime: 100
            };
            this.initialSkipCost = 20;
            this.currentSkipCost = this.initialSkipCost;

            this.isTimeFrozen = false;
            this.gameState = {};
            this.currentScoreValue = this.STARTING_SCORE;
            this.timerInterval = null;
            this.answerSubmitted = false;
            this.domElements = {};

            this.lastCapturedError = null;
            this.setupGlobalErrorHandler();

            this.init();
        }

        setupGlobalErrorHandler() {
            window.onerror = (message, source, lineno, colno, error) => {
                this.lastCapturedError = {
                    message: message,
                    source: source.split('/').pop(),
                    lineno: lineno,
                    colno: colno,
                    error: error ? error.stack : 'N/A'
                };
                console.error("Caught a global error:", this.lastCapturedError);
                return true;
            };
        }

        async loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                this.QUESTIONS = await response.json();
                return true;
            } catch (error) {
                console.error("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", error);
                return false;
            }
        }

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async init() {
            this.cacheDomElements();
            this.bindEventListeners();
            this.populateAvatarGrid();

            const questionsLoaded = await this.loadQuestions();
            
            if (questionsLoaded) {
                this.showScreen('start');
                this.hideLoader();
            } else {
                this.domElements.screens.loader.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.";
            }
        }

        cacheDomElements() {
            this.domElements = {
                screens: {
                    loader: document.getElementById('loader'),
                    start: document.getElementById('startScreen'),
                    avatar: document.getElementById('avatarScreen'),
                    nameEntry: document.getElementById('nameEntry'),
                    instructions: document.getElementById('instructionsScreen'),
                    game: document.getElementById('gameContainer'),
                    levelComplete: document.getElementById('levelCompleteScreen'),
                    end: document.getElementById('endScreen'),
                    leaderboard: document.getElementById('leaderboardScreen'),
                },
                questionText: document.getElementById('questionText'),
                optionsGrid: document.querySelector('.options-grid'),
                scoreDisplay: document.getElementById('currentScore'),
                nameInput: document.getElementById('nameInput'),
                nameError: document.getElementById('nameError'),
                confirmAvatarBtn: document.getElementById('confirmAvatarBtn'),
                themeToggleBtn: document.querySelector('.theme-toggle-btn'),
                confirmExitModal: document.getElementById('confirmExitModal'),
                reportErrorFab: document.getElementById('reportErrorFab'),
                reportErrorModal: document.getElementById('reportErrorModal'),
                lastErrorMessage: document.getElementById('lastErrorMessage'),
            };
        }

        bindEventListeners() {
            document.getElementById('startPlayBtn').addEventListener('click', () => this.showScreen('avatar'));
            this.domElements.confirmAvatarBtn.addEventListener('click', () => this.showScreen('nameEntry'));
            document.getElementById('confirmNameBtn').addEventListener('click', () => this.showScreen('instructions'));
            document.getElementById('instructionsConfirmBtn').addEventListener('click', () => this.startGame());
            document.getElementById('showLeaderboardBtn').addEventListener('click', () => this.displayLeaderboard());
            document.getElementById('backToStartBtn').addEventListener('click', () => this.showScreen('start'));
            this.domElements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
            document.getElementById('endQuizBtn').addEventListener('click', () => this.showConfirmExit());
            document.getElementById('confirmExitYes').addEventListener('click', () => this.endGame());
            document.getElementById('confirmExitNo').addEventListener('click', () => this.hideConfirmExit());
            document.getElementById('nextLevelBtn').addEventListener('click', () => this.nextLevel());
            document.getElementById('quitLevelBtn').addEventListener('click', () => this.endGame());
            document.getElementById('playAgainBtn').addEventListener('click', () => this.resetGame());
            document.getElementById('statsBtn').addEventListener('click', () => this.displayLeaderboard());
            document.querySelectorAll('.helper-btn').forEach(btn => btn.addEventListener('click', (e) => this.useHelper(e)));
            document.getElementById('shareXBtn').addEventListener('click', () => this.shareOnX());
            document.getElementById('shareInstagramBtn').addEventListener('click', () => this.shareOnInstagram());
            this.domElements.nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.showScreen('instructions'); });
            
            // Listeners for report feature
            this.domElements.reportErrorFab.addEventListener('click', () => this.showReportModal());
            document.getElementById('confirmReportYes').addEventListener('click', () => this.sendErrorReport());
            document.getElementById('confirmReportNo').addEventListener('click', () => this.hideReportModal());
        }
        
        populateAvatarGrid() {
            const avatarGrid = document.querySelector('.avatar-grid');
            avatarGrid.innerHTML = '';

            const avatarUrls = [
                // --- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø£Ø´Ø®Ø§Øµ Ø¹Ø§Ù…ÙˆÙ† ğŸ§‘â€ğŸ¤â€ğŸ§‘ ---
                "https://em-content.zobj.net/thumbs/120/apple/354/woman_1f469.png",                // Ø§Ù…Ø±Ø£Ø©
                "https://em-content.zobj.net/thumbs/120/apple/354/man_1f468.png",                  // Ø±Ø¬Ù„
                "https://em-content.zobj.net/thumbs/120/apple/354/woman-curly-hair_1f469-200d-1f9b1.png",   // Ø§Ù…Ø±Ø£Ø© Ø¨Ø´Ø¹Ø± Ù…Ø¬Ø¹Ø¯
                "https://em-content.zobj.net/thumbs/120/apple/354/person-beard_1f9d4.png",                // Ø´Ø®Øµ Ø¨Ù„Ø­ÙŠØ©
                "https://em-content.zobj.net/thumbs/120/apple/354/old-man_1f474.png",                   // Ø±Ø¬Ù„ ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ù†

                // --- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù…Ù‡Ù† ÙˆØ§Ø®ØªØµØ§ØµØ§Øª ğŸ§‘â€ğŸ’¼ ---
                "https://em-content.zobj.net/thumbs/120/apple/354/student_1f9d1-200d-1f393.png",          // Ø·Ø§Ù„Ø¨
                "https://em-content.zobj.net/thumbs/120/apple/354/teacher_1f9d1-200d-1f3eb.png",          // Ù…Ø¹Ù„Ù…
                "https://em-content.zobj.net/thumbs/120/apple/354/scientist_1f9d1-200d-1f52c.png",        // Ø¹Ø§Ù„Ù…
                "https://em-content.zobj.net/thumbs/120/apple/354/health-worker_1f9d1-200d-2695-fe0f.png",   // Ø¹Ø§Ù…Ù„ ØµØ­ÙŠ
                "https://em-content.zobj.net/thumbs/120/apple/354/cook_1f9d1-200d-1f373.png",             // Ø·Ø¨Ø§Ø®
                "https://em-content.zobj.net/thumbs/120/apple/354/farmer_1f9d1-200d-1f33e.png",           // Ù…Ø²Ø§Ø±Ø¹
                "https://em-content.zobj.net/thumbs/120/apple/354/mechanic_1f9d1-200d-1f527.png",          // Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ
                "https://em-content.zobj.net/thumbs/120/apple/354/office-worker_1f9d1-200d-1f4bc.png",     // Ù…ÙˆØ¸Ù Ù…ÙƒØªØ¨
                "https://em-content.zobj.net/thumbs/120/apple/354/artist_1f9d1-200d-1f3a8.png",            // ÙÙ†Ø§Ù†
                "https://em-content.zobj.net/thumbs/120/apple/354/singer_1f9d1-200d-1f3a4.png",            // Ù…ØºÙ†ÙŠ
                "https://em-content.zobj.net/thumbs/120/apple/354/astronaut_1f9d1-200d-1f680.png",         // Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡
                "https://em-content.zobj.net/thumbs/120/apple/354/pilot_1f9d1-200d-2708-fe0f.png",          // Ø·ÙŠØ§Ø±
                "https://em-content.zobj.net/thumbs/120/apple/354/police-officer_1f46e.png",              // Ø¶Ø§Ø¨Ø· Ø´Ø±Ø·Ø©
                "https://em-content.zobj.net/thumbs/120/apple/354/firefighter_1f9d1-200d-1f692.png",       // Ø±Ø¬Ù„ Ø¥Ø·ÙØ§Ø¡
                "https://em-content.zobj.net/thumbs/120/apple/354/detective_1f575-fe0f.png",              // Ù…Ø­Ù‚Ù‚
                "https://em-content.zobj.net/thumbs/120/apple/354/judge_1f9d1-200d-2696-fe0f.png",          // Ù‚Ø§Ø¶ÙŠ

                // --- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø´Ø®ØµÙŠØ§Øª Ø®ÙŠØ§Ù„ÙŠØ© ÙˆÙ…Ù…ÙŠØ²Ø© ğŸ¦¸â€â™‚ï¸ ---
                "https://em-content.zobj.net/thumbs/120/apple/354/superhero_1f9b8.png",              // Ø¨Ø·Ù„ Ø®Ø§Ø±Ù‚
                "https://em-content.zobj.net/thumbs/120/apple/354/mage_1f9d9.png",                   // Ø³Ø§Ø­Ø±
                "https://em-content.zobj.net/thumbs/120/apple/354/elf_1f9dd.png"                     // Ù‚Ø²Ù…
            ];

            avatarUrls.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url; 
                img.alt = `ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ${index + 1}`;
                img.classList.add('avatar-option');
        
                img.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-option.selected').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                    this.gameState.avatar = img.src;
                    this.domElements.confirmAvatarBtn.disabled = false;

                    img.classList.add('clicked'); 

                    setTimeout(() => {
                        img.classList.remove('clicked');
                    }, 300); 
                });
                
                avatarGrid.appendChild(img);
            });
        }
        
        showScreen(screenName) {
            if (document.activeElement) document.activeElement.blur();
            
            Object.values(this.domElements.screens).forEach(screen => {
                screen.classList.remove('active');
                screen.setAttribute('aria-hidden', 'true');
            });
            const activeScreen = this.domElements.screens[screenName];
            if (activeScreen) {
                activeScreen.classList.add('active');
                activeScreen.setAttribute('aria-hidden', 'false');
                const firstFocusable = activeScreen.querySelector('button, [href], input, select, textarea');
                if(firstFocusable) firstFocusable.focus();
            }
        }

        hideLoader() {
            this.domElements.screens.loader.classList.remove('active');
        }

        async startGame() {
            const name = this.domElements.nameInput.value.trim();
            if (name.length < 2) {
                this.domElements.nameError.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
                this.domElements.nameError.classList.add('show');
                return;
            }

            this.gameState = {
                name: name,
                avatar: this.gameState.avatar,
                playerId: this.generatePlayerId(),
                deviceId: this.generateDeviceId(), 
                level: 0,
                question: 0,
                wrongAnswers: 0,
                correctAnswers: 0,
                skips: 0,
                startTime: new Date(),
                helpersUsed: { fiftyFifty: false, freezeTime: false },
                currentStreak: 0,
                bestStreak: 0,   
            };

            this.currentSkipCost = this.initialSkipCost;

            this.updateScore(this.STARTING_SCORE);
            this.setupGameUI();
            this.showScreen('game');
            this.startLevel();
        }

        generatePlayerId() {
            return `P${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
        }
        
        generateDeviceId() {
            let deviceId = localStorage.getItem('quizGameDeviceId');
            if (!deviceId) {
                deviceId = 'D' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9).toUpperCase();
                localStorage.setItem('quizGameDeviceId', deviceId);
            }
            return deviceId;
        }


        startLevel() {
            const currentLevel = this.LEVELS[this.gameState.level];
            document.body.setAttribute('data-level', currentLevel.name);
            document.getElementById('currentLevelBadge').textContent = currentLevel.label;

            let levelQuestions = [...this.QUESTIONS[currentLevel.name]];
            if (currentLevel.name !== 'impossible') {
                this.shuffleArray(levelQuestions);
            }
            this.gameState.shuffledQuestions = levelQuestions;

            document.querySelectorAll('.level-indicator').forEach((indicator, index) => {
                if (index < this.gameState.level) {
                    indicator.classList.add('completed', 'active');
                } else if (index === this.gameState.level) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
            
            this.gameState.question = 0;
            this.fetchQuestion();
        }

        fetchQuestion() {
            const questions = this.gameState.shuffledQuestions;
        
            if (!questions || this.gameState.question >= questions.length) {
        
                const isLastLevel = this.gameState.level >= this.LEVELS.length - 1;
        
                if (isLastLevel) {
                    this.endGame(); 
                } else {
                    this.levelComplete();
                }
                return; 
            }
    
            const questionData = questions[this.gameState.question];
            this.displayQuestion(questionData);
        }

        displayQuestion(questionData) {
            this.answerSubmitted = false;
            
            const correctAnswerText = questionData.options[questionData.correct];
            let shuffledOptions = [...questionData.options];
            this.shuffleArray(shuffledOptions);

            const totalQuestionsInLevel = this.gameState.shuffledQuestions.length;
            document.getElementById('questionCounter').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${this.gameState.question + 1} Ù…Ù† ${totalQuestionsInLevel}`;
            
            this.domElements.questionText.textContent = questionData.q;
            this.domElements.optionsGrid.innerHTML = '';

            shuffledOptions.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = optionText;
                
                const isCorrect = optionText === correctAnswerText;
                if (isCorrect) {
                    button.dataset.correct = 'true';
                }
                
                button.addEventListener('click', () => this.checkAnswer(isCorrect, button));
                
                this.domElements.optionsGrid.appendChild(button);
            });

            this.updateUI();
            this.startTimer();
        }

        checkAnswer(isCorrect, selectedButton) {
            if (this.answerSubmitted) return;
            this.answerSubmitted = true;
    
            clearInterval(this.timerInterval);
            document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));

            if (isCorrect) {
                selectedButton.classList.add('correct');
                this.updateScore(this.currentScoreValue + 100);
                this.gameState.correctAnswers++;
                this.showToast("Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +100 Ù†Ù‚Ø·Ø©", "success");

                this.gameState.currentStreak++;
                if (this.gameState.currentStreak > this.gameState.bestStreak) {
                    this.gameState.bestStreak = this.gameState.currentStreak;
                }
            } else {
                selectedButton.classList.add('wrong');
        
                const correctButton = this.domElements.optionsGrid.querySelector('[data-correct="true"]');
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
        
                this.gameState.wrongAnswers++;
                this.updateScore(this.currentScoreValue - 100);
                this.showToast("Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! -100 Ù†Ù‚Ø·Ø©", "error");

                this.gameState.currentStreak = 0;
            }

            this.gameState.question++;
            this.updateUI();

            const isGameOver = this.gameState.wrongAnswers >= this.MAX_WRONG_ANSWERS;
    
            setTimeout(() => {
                if (isGameOver) {
                    this.endGame();
                } else if (this.gameState.question >= this.gameState.shuffledQuestions.length) {
                    this.levelComplete();
                } else {
                    this.fetchQuestion();
                }
            }, 2000);
        }
        
        levelComplete() {
            const currentLevel = this.LEVELS[this.gameState.level];
            document.getElementById('levelCompleteTitle').textContent = `ğŸ‰ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel.label}!`;
            document.getElementById('levelScore').textContent = this.formatNumber(this.currentScoreValue);
            document.getElementById('levelErrors').textContent = this.gameState.wrongAnswers;
            document.getElementById('levelCorrect').textContent = this.gameState.correctAnswers;
            
            this.showScreen('levelComplete');
        }
        
        nextLevel() {
            this.gameState.level++;
            
            if (this.gameState.level >= this.LEVELS.length) {
                this.endGame();
            } else {
                this.showScreen('game');
                this.startLevel();
            }
        }

        endGame() {
            clearInterval(this.timerInterval);
            this.hideConfirmExit();

            const totalTimeSeconds = (new Date() - this.gameState.startTime) / 1000;
            const currentLevel = this.LEVELS[Math.min(this.gameState.level, this.LEVELS.length - 1)];
            const totalAnswered = this.gameState.correctAnswers + this.gameState.wrongAnswers;
    
            const accuracy = totalAnswered > 0 ? parseFloat(((this.gameState.correctAnswers / totalAnswered) * 100).toFixed(1)) : 0.0;
            const avgTime = totalAnswered > 0 ? parseFloat((totalTimeSeconds / totalAnswered).toFixed(1)) : 0;
            const performanceRating = this.calculatePerformanceRating();

            document.getElementById('finalName').textContent = this.gameState.name;
            document.getElementById('finalId').textContent = this.gameState.playerId;
            document.getElementById('finalCorrect').textContent = this.gameState.correctAnswers;
            document.getElementById('finalWrong').textContent = this.gameState.wrongAnswers;
            document.getElementById('finalSkips').textContent = this.gameState.skips;
            document.getElementById('finalScore').textContent = this.formatNumber(this.currentScoreValue);
            document.getElementById('totalTime').textContent = this.formatTime(totalTimeSeconds);
            document.getElementById('finalLevel').textContent = currentLevel.label;
            document.getElementById('finalAccuracy').textContent = `${accuracy}%`;
            document.getElementById('finalBestStreak').textContent = this.gameState.bestStreak;
            document.getElementById('finalAvgTime').textContent = `${this.formatTime(avgTime)} / Ø³Ø¤Ø§Ù„`;
            document.getElementById('performanceText').textContent = performanceRating;

            const resultsData = {
                name: this.gameState.name,
                deviceId: this.gameState.deviceId,
                playerId: this.gameState.playerId,
                correct: this.gameState.correctAnswers,
                wrong: this.gameState.wrongAnswers,
                level: currentLevel.label,
                score: Number(this.currentScoreValue) || 0, 
                accuracy: accuracy,
                bestStreak: this.gameState.bestStreak,
                totalTime: Math.round(totalTimeSeconds),
                avgTime: avgTime,
                skips: this.gameState.skips,
                usedFiftyFifty: this.gameState.helpersUsed.fiftyFifty,
                usedFreezeTime: this.gameState.helpersUsed.freezeTime
            };
    
            this.saveResults(resultsData);
    
            this.showScreen('end');
        }

        async saveResults(resultsData) {
            console.log("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª:", resultsData);
            try {
                const response = await this.apiCall({
                    action: 'endGame',
                    ...resultsData
                });

                if (response.success) {
                    this.showToast("ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                    console.log("GAS Response:", response);
                } else {
                    throw new Error(response.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
                }
            } catch (error) {
                console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:", error);
                this.showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©.", "error");
            }
        }
        
        calculatePerformanceRating() {
            const totalQuestions = this.gameState.correctAnswers + this.gameState.wrongAnswers;
            if (totalQuestions === 0) return "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„";
            
            const accuracy = (this.gameState.correctAnswers / totalQuestions) * 100;
            
            if (accuracy >= 90) return "Ù…Ù…ØªØ§Ø² ğŸ†";
            if (accuracy >= 75) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ â­";
            if (accuracy >= 60) return "Ø¬ÙŠØ¯ ğŸ‘";
            if (accuracy >= 40) return "Ù…Ù‚Ø¨ÙˆÙ„ ğŸ‘Œ";
            return "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ“ˆ";
        }

        useHelper(event) {
            const btn = event.currentTarget;
            const type = btn.dataset.type;

            if (type === 'skipQuestion') {
                if (this.currentScoreValue < this.currentSkipCost) {
                    this.showToast("Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø·ÙŠ!", "error");
                    return;
                }
                
                this.updateScore(this.currentScoreValue - this.currentSkipCost);
                this.showToast(`ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ! -${this.currentSkipCost} Ù†Ù‚Ø·Ø©`, "success");
                this.currentSkipCost += 20; 

                this.gameState.skips++;
                this.gameState.question++;
                this.updateUI();
                this.fetchQuestion();

            } else {
                if (this.gameState.helpersUsed[type]) {
                    this.showToast("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!", "info");
                    return;
                }

                const cost = this.HELPER_COSTS[type];
                if (this.currentScoreValue < cost) {
                    this.showToast("Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!", "error");
                    return;
                }

                this.updateScore(this.currentScoreValue - cost);
                this.gameState.helpersUsed[type] = true;
                this.updateUI();
                this.showToast(`ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©! -${cost} Ù†Ù‚Ø·Ø©`, "success");

                if (type === 'fiftyFifty') {
                    const options = Array.from(this.domElements.optionsGrid.querySelectorAll('.option-btn'));
                    let wrongOptions = options.filter(btn => btn.dataset.correct !== 'true');
                    
                    wrongOptions.sort(() => 0.5 - Math.random());
                    if(wrongOptions.length > 1) {
                        wrongOptions[0].classList.add('hidden');
                        wrongOptions[1].classList.add('hidden');
                    }
                } else if (type === 'freezeTime') {
                    this.isTimeFrozen = true;
                    document.querySelector('.timer-bar').classList.add('frozen');
                    setTimeout(() => {
                        this.isTimeFrozen = false;
                        document.querySelector('.timer-bar').classList.remove('frozen');
                    }, 10000);
                }
            }
        }

        startTimer() {
            clearInterval(this.timerInterval);
            let timeLeft = this.QUESTION_TIME;
            const timerBar = document.querySelector('.timer-bar');
            const timerDisplay = document.querySelector('.timer-text');

            timerDisplay.textContent = timeLeft;
            timerBar.style.width = '100%';

            this.timerInterval = setInterval(() => {
                if (this.isTimeFrozen) return;

                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerBar.style.width = `${(timeLeft / this.QUESTION_TIME) * 100}%`;

                if (timeLeft <= 0) {
                    clearInterval(this.timerInterval);
                    this.showToast("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!", "error");
                    this.gameState.wrongAnswers++;
                    this.updateScore(this.currentScoreValue - 100);
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));
                    
                    const correctButton = this.domElements.optionsGrid.querySelector('[data-correct="true"]');
                    if (correctButton) {
                        correctButton.classList.add('correct');
                    }
                    
                    this.updateUI();
                    
                    setTimeout(() => {
                        if (this.gameState.wrongAnswers >= this.MAX_WRONG_ANSWERS) {
                            this.endGame();
                        } else {
                            this.gameState.question++;
                            this.fetchQuestion();
                        }
                    }, 2000);
                }
            }, 1000);
        }
        
        updateScore(newScore) {
            this.currentScoreValue = newScore;
            this.domElements.scoreDisplay.textContent = this.formatNumber(this.currentScoreValue);
            this.updateUI();
        }

        updateUI() {
            document.getElementById('wrongAnswersCount').textContent = `${this.gameState.wrongAnswers} / ${this.MAX_WRONG_ANSWERS}`;
            document.getElementById('skipCount').textContent = this.gameState.skips;

            const skipCostSpan = document.getElementById('skipCost');
            if (skipCostSpan) {
                skipCostSpan.textContent = `(${this.currentSkipCost})`;
            }

            document.querySelectorAll('.helper-btn').forEach(btn => {
                const type = btn.dataset.type;
                if (type !== 'skipQuestion') {
                    const helperIsUsed = this.gameState.helpersUsed[type];
                    btn.disabled = helperIsUsed;
                }
            });
        }

        setupGameUI() {
            document.getElementById('playerAvatar').src = this.gameState.avatar;
            document.getElementById('playerName').textContent = this.gameState.name;
            document.getElementById('playerId').textContent = this.gameState.playerId;
        }

        toggleTheme() {
            const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
            this.domElements.themeToggleBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        showConfirmExit() {
            this.domElements.confirmExitModal.classList.add('active');
        }

        hideConfirmExit() {
            this.domElements.confirmExitModal.classList.remove('active');
        }

        showReportModal() {
            if (this.lastCapturedError) {
                this.domElements.lastErrorMessage.textContent = `Error: ${this.lastCapturedError.message} at line ${this.lastCapturedError.lineno}`;
                this.domElements.lastErrorMessage.style.display = 'block';
            } else {
                this.domElements.lastErrorMessage.textContent = "Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ Ø®Ø·Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠ.";
                this.domElements.lastErrorMessage.style.display = 'block';
            }
            this.domElements.reportErrorModal.classList.add('active');
        }

        hideReportModal() {
            this.domElements.reportErrorModal.classList.remove('active');
        }

        async sendErrorReport() {
            const reportData = {
                errorDetails: this.lastCapturedError || "No automatic error captured.",
                gameState: {
                    name: this.gameState.name || 'N/A',
                    playerId: this.gameState.playerId || 'N/A',
                    level: this.gameState.level !== undefined ? this.LEVELS[this.gameState.level].label : 'N/A',
                    score: this.currentScoreValue
                },
                userAgent: navigator.userAgent
            };

            console.log("Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¨Ø§Ù„Ø®Ø·Ø£:", reportData);
            this.hideReportModal();
            this.showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº...", "info");

            try {
                const response = await this.apiCall({
                    action: 'reportError',
                    data: reportData
                });

                if (response.success) {
                    this.showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!", "success");
                } else {
                    throw new Error(response.error || "ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº");
                }
            } catch (error) {
                console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº:", error);
                this.showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº.", "error");
            }
            this.lastCapturedError = null; // Clear the error after reporting
        }

        showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async apiCall(payload) {
            const payloadWithKey = {
                apiKey: this.API_KEY,
                ...payload
            };

            try {
                const response = await fetch(this.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payloadWithKey)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async displayLeaderboard() {
            this.showScreen('leaderboard');
            const contentDiv = document.getElementById('leaderboardContent');
            contentDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await this.apiCall({ action: 'getLeaderboard' });
                if (response && response.success && response.leaderboard) {
                    let tableHTML = '<p>Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠÙ‹Ø§!</p>';
                    if (response.leaderboard.length > 0) {
                        // --- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ ---
                        tableHTML = `<table class="leaderboard-table" style="width:100%; text-align:right; border-collapse: collapse;">
                            <thead style="font-weight:bold;"><tr><th style="padding:8px;">Ø§Ù„ØªØ±ØªÙŠØ¨</th><th style="padding:8px;">Ø§Ù„Ø§Ø³Ù…</th><th style="padding:8px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</th><th style="padding:8px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                            <tbody>${response.leaderboard.map((row, index) => `
                                <tr>
                                    <td style="padding:8px;">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || index + 1}</td>
                                    <td style="padding:8px;">${row.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                                    <td style="padding:8px;">${row.attempt || 'N/A'}</td>
                                    <td style="padding:8px;">${row.date || 'N/A'}</td>
                                </tr>`).join('')}</tbody>
                        </table>`;
                    }
                    contentDiv.innerHTML = tableHTML;
                } else {
                    contentDiv.innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©.</p>';
                }
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                contentDiv.innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©.</p>';
            }
        }
        
        getShareText() {
            const performanceRating = this.calculatePerformanceRating();
            return `ğŸ§  Ù†ØªØ§Ø¦Ø¬ÙŠ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ğŸ§ \n` +
                  `Ø§Ù„Ø§Ø³Ù…: ${this.gameState.name}\n` +
                  `Ø§Ù„Ù†Ù‚Ø§Ø·: ${this.formatNumber(this.currentScoreValue)}\n` +
                  `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${this.LEVELS[Math.min(this.gameState.level, this.LEVELS.length - 1)].label}\n` +
                  `Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${performanceRating}\n\n` +
                  `ğŸ”— Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠÙƒ Ø£Ù†Øª Ø£ÙŠØ¶Ø§Ù‹!`;
        }
        
        shareOnX() {
            const text = encodeURIComponent(this.getShareText());
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        shareOnInstagram() {
            navigator.clipboard.writeText(this.getShareText())
                .then(() => this.showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©! Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù‚ØµØªÙƒ Ø£Ùˆ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù….", "success"))
                .catch(() => this.showToast("ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©.", "error"));
        }

        resetGame() {
            this.showScreen('start');
        }
        
        formatTime(totalSeconds) {
            const total = Math.floor(totalSeconds);
            const minutes = Math.floor(total / 60);
            const seconds = total % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        formatNumber(num) {
            return new Intl.NumberFormat('ar-EG').format(num);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.dataset.theme = savedTheme;
        
        new QuizGame();
    });
</script>
    
    <div class="sr-only" aria-live="polite" id="liveAnnouncements"></div>
</body>
</html>


